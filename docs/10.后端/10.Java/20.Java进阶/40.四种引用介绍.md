---
title: å››ç§å¼•ç”¨ä»‹ç»
date: 2022-07-13 18:31:09
permalink: /pages/b36331/
categories:
  - Java
  - JavaåŸºç¡€
  - è¿›é˜¶çŸ¥è¯†
tags:
  - Java
author: 
  name: Marvel
  link: https://github.com/zouquchen
---
# å››ç§å¼•ç”¨ä»‹ç»

## 1. å››ç§å¼•ç”¨ä»‹ç»

- å¼ºå¼•ç”¨(Strong Reference)ï¼šå¤§éƒ¨åˆ†çš„å¯¹è±¡çš„å¼•ç”¨éƒ½æ˜¯å¼ºå¼•ç”¨ï¼Œnew å‡ºæ¥çš„å¯¹è±¡å°±æ˜¯å¼ºå¼•ç”¨ç±»å‹ï¼Œå¼ºå¼•ç”¨çš„å¯¹è±¡æ˜¯å¿…ä¸å¯å°‘çš„å­˜åœ¨ï¼Œåƒåœ¾å›æ”¶ä¸ä¼šå›æ”¶è¿™äº›å¯¹è±¡ï¼Œå³ä½¿å†…å­˜ç©ºé—´ä¸è¶³ï¼Œjvm å®å¯æŠ›å‡º OutOfMemeryError é”™è¯¯ï¼Œä½¿ç¨‹åºç»ˆæ­¢ï¼Œä¹Ÿä¸ä¼šå›æ”¶å¼ºå¼•ç”¨å¯¹è±¡ã€‚
- è½¯å¼•ç”¨(Soft Reference)ï¼šå½“å†…å­˜ç©ºé—´è¶³å¤Ÿçš„æ—¶å€™ï¼Œåƒåœ¾å›æ”¶ä¸ä¼šå›æ”¶è¿™äº›å¯¹è±¡ï¼›å½“å†…å­˜ç©ºé—´ä¸è¶³çš„æ—¶å€™ï¼Œåƒåœ¾å›æ”¶å°±ä¼šå›æ”¶è¿™äº›å¯¹è±¡ã€‚ä½¿ç”¨`SoftReference `ä¿®é¥°ã€‚
- å¼±å¼•ç”¨(Weak Reference)ï¼šå½“è¿›è¡Œåƒåœ¾å›æ”¶æ˜¯ï¼Œä¸ç®¡å†…å­˜æ˜¯å¦è¶³å¤Ÿï¼Œéƒ½ä¼šå°†å¼±å¼•ç”¨å¯¹è±¡è¿›è¡Œå›æ”¶ã€‚ä½¿ç”¨`WeakReference`ä¿®é¥°ã€‚é€šå¸¸ç”¨äºå®ç°å¯¹è±¡çš„è¾…åŠ©æ•°æ®ç»“æ„ï¼Œå½“å¯¹è±¡ä¸å†è¢«å¼ºå¼•ç”¨å¼•ç”¨æ—¶ï¼Œå¯ä»¥é€šè¿‡å¼±å¼•ç”¨æ¥è·å–å¯¹è±¡çš„ç›¸å…³ä¿¡æ¯ã€‚
- è™šå¼•ç”¨(Phantom Reference)ï¼šä»–ä¸èƒ½å•ç‹¬ä½¿ç”¨ï¼Œå¿…é¡»å’Œå¼•ç”¨é˜Ÿåˆ—è”åˆä½¿ç”¨ï¼Œè™šå¼•ç”¨ä¸»è¦ç”¨æ¥è·Ÿè¸ªå¯¹è±¡è¢«åƒåœ¾å›æ”¶çš„æ´»åŠ¨ã€‚



## 2. è½¯å¼•ç”¨

å½“å†…å­˜ç©ºé—´è¶³å¤Ÿçš„æ—¶å€™ï¼Œåƒåœ¾å›æ”¶ä¸ä¼šå›æ”¶è¿™äº›å¯¹è±¡ï¼›å½“å†…å­˜ç©ºé—´ä¸è¶³çš„æ—¶å€™ï¼Œåƒåœ¾å›æ”¶å°±ä¼šå›æ”¶è¿™äº›å¯¹è±¡ã€‚

ğŸ–¥ **ä»£ç **

```java
SoftReference<Object> softReference = new SoftReference<>(new Object());
System.out.println(softReference.get()); // è¾“å‡ºå¯¹è±¡åœ°å€
try {
    byte[] bytes = new byte[30 *1024 *1024];
} finally {
    System.out.println(softReference.get());  // null
}
```

ğŸ“ƒ **ä½¿ç”¨åœºæ™¯**

å‡å¦‚ä¸€ä¸ªåº”ç”¨éœ€è¦è¯»å–å¤§é‡çš„å›¾ç‰‡ï¼Œå¦‚æœæ¯æ¬¡è¯»å–å›¾ç‰‡éƒ½ä»ç¡¬ç›˜è¯»å–åˆ™ä¼šä¸¥é‡å½±å“æ€§èƒ½ï¼Œå¦‚æœä¸€æ¬¡æ€§å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ä¸­æœ‰å¯èƒ½é€ æˆå†…å­˜æº¢å‡ºã€‚

è®¾è®¡æ€è·¯ï¼šç”¨ä¸€ä¸ªHashMapæ¥ä¿å­˜å›¾ç‰‡çš„è·¯å¾„å’Œç›¸åº”å›¾ç‰‡å¯¹è±¡å…³è”çš„è½¯å¼•ç”¨ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Œåœ¨å†…å­˜ä¸è¶³æ—¶ï¼ŒJVMä¼šè‡ªåŠ¨å›æ”¶è¿™äº›ç¼“å­˜å›¾ç‰‡å¯¹è±¡å ç”¨çš„ç©ºé—´ï¼Œä»è€Œæœ‰æ•ˆé¿å…äº†OOMçš„é—®é¢˜ã€‚

`Map<String, SoftReference<Bitmap>> imageCache = new HashMap<>();`



## 3. å¼±å¼•ç”¨

å½“è¿›è¡Œåƒåœ¾å›æ”¶æ˜¯ï¼Œä¸ç®¡å†…å­˜æ˜¯å¦è¶³å¤Ÿï¼Œéƒ½ä¼šå°†å¼±å¼•ç”¨å¯¹è±¡è¿›è¡Œå›æ”¶ã€‚

ğŸ–¥ **ä»£ç **

```java
WeakReference<Object> weakReference = new WeakReference<>(new Object());
System.out.println(weakReference.get()); // è¾“å‡ºå¯¹è±¡åœ°å€
System.gc();
System.out.println(weakReference.get()); // null
```

ğŸŒ° **åº”ç”¨åœºæ™¯**ï¼šWeakHashMapã€ThreadLocal

WeakHashMapä½¿ç”¨äº†å¼±å¼•ç”¨ï¼Œå½“entryé”®å€¼å¯¹ä¸­çš„é”®ä¸å†è¢«å¼•ç”¨çš„æ—¶å€™ï¼Œåœ¨åƒåœ¾å›æ”¶çš„æ—¶å€™ï¼Œè¿™ä¸ªentryå°±ä¼šè¢«åƒåœ¾å›æ”¶ã€‚

```java
Integer key = new Integer(1);
String value = "s";

Map<Integer, String> map = new WeakHashMap<>();

map.put(key, value);
System.out.println(key); // 1
System.out.println(map); // {1=s}
System.out.println("-----------------------------");

key = null;
System.out.println(key); // null
System.out.println(map); // {1=s}
System.out.println("-----------------------------");

System.gc();
System.out.println(key); // null
System.out.println(map); // {}        å¦‚æœæ˜¯HashMapï¼Œè¿™é‡Œå°±ä¸º{1=s}
System.out.println("-----------------------------");
```

ThreadLocal ä¹ŸåŒæ ·åº”ç”¨äº†å¼±å¼•ç”¨ï¼ŒTreadLocalMap ä¸­çš„ Entry çš„é”®å°±æ˜¯å¼±å¼•ç”¨ã€‚

```java
static class Entry extends WeakReference<ThreadLocal<?>> {
    /** The value associated with this ThreadLocal. */
    Object value;

    Entry(ThreadLocal<?> k, Object v) {
        super(k);
        value = v;
    }
}
```



## 4. è™šå¼•ç”¨

è™šå¼•ç”¨ä¸ä¼šå†³å®šå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡æŒæœ‰è™šå¼•ç”¨ï¼Œé‚£ä¹ˆå®ƒå°±å’Œæ²¡æœ‰ä»»ä½•å¼•ç”¨ä¸€æ ·ï¼Œåœ¨ä»»ä½•æ—¶å€™éƒ½å¯èƒ½è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ï¼Œä»–ä¸èƒ½å•ç‹¬ä½¿ç”¨ï¼Œä¹Ÿä¸èƒ½é€šè¿‡å®ƒè®¿é—®å¯¹è±¡ï¼Œè™šå¼•ç”¨å¿…é¡»å’Œå¼•ç”¨é˜Ÿåˆ—`ReferenceQueue`è”åˆä½¿ç”¨ã€‚

è™šå¼•ç”¨çš„ä½œç”¨æ˜¯è·Ÿè¸ªå¯¹è±¡è¢«åƒåœ¾å›æ”¶çš„çŠ¶æ€ã€‚ä»…ä»…æä¾›äº†ä¸€ç§ç¡®ä¿å¯¹è±¡è¢«finalizeä¹‹åï¼ŒåšæŸäº›äº‹æƒ…çš„æœºåˆ¶ã€‚

```java
ReferenceQueue<Object> referenceQueue = new ReferenceQueue<>();
PhantomReference<Object> phantomReference = new PhantomReference<>(new Object(), referenceQueue);

System.out.println(phantomReference.get()); // null
System.out.println(referenceQueue.poll()); // null

System.out.println("----------------------------");
System.gc();
Thread.sleep(500);

System.out.println(phantomReference.get()); // null
System.out.println(referenceQueue.poll()); // java.lang.ref.PhantomReference@1b6d3586
```



æ„é€ æ—¶å¿…é¡»ä¼ å…¥å¼•ç”¨é˜Ÿåˆ—ï¼š

```java
public PhantomReference(T referent, ReferenceQueue<? super T> q)
```

è™šå¼•ç”¨å’Œå¼•ç”¨é˜Ÿåˆ—å…³è”ä½¿ç”¨ï¼Œå½“åƒåœ¾å›æ”¶å™¨å‡†å¤‡å›æ”¶ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œå¦‚æœå‘ç°å®ƒè¿˜æ˜¯è™šå¼•ç”¨ï¼Œå°±ä¼šæŠŠè¿™ä¸ªè™šå¼•ç”¨åŠ å…¥åˆ°ä¸ä¹‹å…³è”çš„å¼•ç”¨é˜Ÿåˆ—ä¸­ã€‚ç¨‹åºå¯ä»¥é€šè¿‡åˆ¤æ–­å¼•ç”¨é˜Ÿåˆ—ä¸­æ˜¯å¦å·²ç»åŠ å…¥äº†è™šå¼•ç”¨ï¼Œæ¥äº†è§£è¢«å¼•ç”¨çš„å¯¹è±¡æ˜¯å¦è¦å°†åƒåœ¾å›æ”¶ã€‚å¦‚æœç¨‹åºå‘ç°æŸä¸ªè™šå¼•ç”¨å·²ç»è¢«åŠ å…¥åˆ°å¼•ç”¨é˜Ÿåˆ—ï¼Œå°±å¯ä»¥åœ¨æ‰€å¼•ç”¨çš„å¯¹è±¡çš„å†…å­˜è¢«å›æ”¶ä¹‹å‰é‡‡å–å¿…è¦çš„è¡ŒåŠ¨ã€‚

## 5. å¼•ç”¨é˜Ÿåˆ—

å¯¹è±¡è¢«å›æ”¶å‰éœ€è¦è¢«å¼•ç”¨é˜Ÿåˆ—ä¿å­˜ï¼Œä¸‹é¢ä»¥å¼±å¼•ç”¨ä¸ºä¾‹ï¼š

```java
ReferenceQueue<Object> referenceQueue = new ReferenceQueue<>();
WeakReference<Object> weakReference = new WeakReference<>(new Object(), referenceQueue);

System.out.println(weakReference.get());  // java.lang.Object@1b6d3586
System.out.println(referenceQueue.poll()); // null

System.out.println("----------------------------");
System.gc();
Thread.sleep(500);

System.out.println(weakReference.get()); // null
System.out.println(referenceQueue.poll()); // java.lang.ref.WeakReference@4554617c
```

å¼•ç”¨å’Œå¼•ç”¨é˜Ÿåˆ—çš„ç»§æ‰¿å…³ç³»

<img src="https://raw.githubusercontent.com/zouquchen/Images/main/imgs2022/Java-Reference-Relation.png" alt="image-20220621202655619" style="zoom: 80%;" />