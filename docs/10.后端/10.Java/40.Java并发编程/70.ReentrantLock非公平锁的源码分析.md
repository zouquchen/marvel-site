---
title: ReentrantLockéå…¬å¹³é”çš„æºç åˆ†æ
date: 2024-02-19 21:01:24
permalink: /pages/549df8/
categories:
  - Java
  - Javaå¹¶å‘ç¼–ç¨‹
tags:
  - Java
  - JUC
  - æºç 
author: 
  name: Marvel
  link: https://github.com/zouquchen
---

ReentrantLock éå…¬å¹³é”çš„å®ç°æºç åˆ†æï¼šlockã€unlockã€çº¿ç¨‹é˜»å¡ã€é˜»å¡çº¿ç¨‹å¦‚ä½•å”¤é†’ç­‰
<!-- more -->

## 1. å‰ç½®çŸ¥è¯†
### 1.1 CAS

CASï¼ŒCompare And Swapï¼Œæ¯”è¾ƒä¸äº¤æ¢ï¼Œæ˜¯ä¸€ç§æ— é”çš„ç®—æ³•ã€‚åœ¨ä¸ä½¿ç”¨é”çš„æƒ…å†µä¸‹å®ç°å¤šçº¿ç¨‹ä¹‹é—´å˜é‡çš„åŒæ­¥ã€‚

CASæ“ä½œæ¶‰åŠä¸‰ä¸ªæ“ä½œæ•°ï¼šéœ€è¦è¯»å†™çš„å†…å­˜å€¼Vï¼Œè¿›è¡Œæ¯”è¾ƒçš„å€¼Aï¼Œè¦å†™å…¥çš„æ–°å€¼Bã€‚

å½“V=Aæ—¶ï¼ŒCASé€šè¿‡åŸå­æ–¹å¼ç”¨æ–°å€¼Bæ›´æ–°å†…å­˜ä¸­çš„æ—§å€¼Vï¼Œå¦åˆ™å°†ä¸ä¼šæ‰§è¡Œæ“ä½œã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œâ€æ›´æ–°â€œæ˜¯ä¸€ä¸ªä¸æ–­é‡è¯•çš„æ“ä½œã€‚

### 1.2 Unsafeç±»

åœ¨Javaä¸­ï¼Œ**Unsafeç±»æ˜¯CASçš„æ ¸å¿ƒç±»**ï¼Œå­˜åœ¨äº`sun.misc`åŒ…ä¸­ï¼Œç”±äºJavaæ–¹æ³•æ— æ³•ç›´æ¥è®¿é—®åº•å±‚ç³»ç»Ÿï¼Œéœ€è¦æœ¬åœ°ï¼ˆNativeï¼‰æ–¹æ³•æ¥è®¿é—®ï¼ŒUnsafeç›¸å½“äºä¸€ä¸ªåé—¨ï¼Œå…¶å†…éƒ¨æ–¹æ³•æ“ä½œå¯ä»¥åƒCçš„æŒ‡é’ˆä¸€æ ·ç›´æ¥æ“ä½œå†…å­˜ã€‚ 

**CASï¼Œæ˜¯ä¸€æ¡CPUå¹¶å‘åŸè¯­**ã€‚å®ƒçš„åŠŸèƒ½æ˜¯åˆ¤æ–­å†…å­˜æŸä¸ªä½ç½®æ˜¯å¦ä½é¢„æœŸå€¼ï¼Œå¦‚æœæ˜¯åˆ™æ›´æ”¹ä¸ºæ–°çš„å€¼ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯åŸå­çš„ã€‚JVMä¼šå¸®æˆ‘ä»¬å®ç°å‡ºCASæ±‡ç¼–æŒ‡ä»¤ã€‚è¿™æ˜¯ä¸€ç§å®Œå…¨ä¾èµ–äºç¡¬ä»¶çš„åŠŸèƒ½ï¼Œé€šè¿‡å®ƒå®ç°äº†åŸå­æ“ä½œã€‚
>åŸè¯­çš„æ‰§è¡Œå¿…é¡»æ˜¯è¿ç»­çš„ï¼Œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸å…è®¸è¢«ä¸­æ–­ï¼Œä¹Ÿå°±æ˜¯è¯´CASæ˜¯ä¸€æ¡CPUçš„åŸå­æŒ‡ä»¤ï¼Œä¸ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚

```java
public final class Unsafe {
	...
	// CASç›¸å…³
    public final native boolean compareAndSwapObject(Object var1, long var2, Object var4, Object var5);
    public final native boolean compareAndSwapInt(Object var1, long var2, int var4, int var5);
    public final native boolean compareAndSwapLong(Object var1, long var2, long var4, long var6);
    
    // é˜»å¡ç›¸å…³
    public native void unpark(Object var1);
    public native void park(boolean var1, long var2);
    ...
}
```

### 1.2 LockSupport
LockSupportæ˜¯ç”¨æ¥åˆ›å»ºé”å’Œå…¶ä»–åŒæ­¥ç±»çš„åŸºæœ¬çº¿ç¨‹é˜»å¡åŸè¯­ï¼Œæ˜¯ä¸€ä¸ª**çº¿ç¨‹é˜»å¡å·¥å…·ç±»**ï¼Œæ‰€æœ‰çš„æ–¹æ³•éƒ½æ˜¯é™æ€æ–¹æ³•ï¼Œå¯ä»¥è®©çº¿ç¨‹åœ¨ä»»æ„ä½ç½®é˜»å¡ï¼Œé˜»å¡ä¹‹åä¹Ÿæœ‰å¯¹åº”çš„å”¤é†’æ–¹æ³•ã€‚å½’æ ¹ç»“åº•ï¼ŒLockSupportè°ƒç”¨çš„Unsafeä¸­çš„nativeä»£ç ã€‚

**LockSupportä¸­çš„`park()`å’Œ`unpark()`çš„ä½œç”¨åˆ†åˆ«æ˜¯é˜»å¡çº¿ç¨‹å’Œè§£é™¤é˜»å¡çº¿ç¨‹ã€‚**

LockSupportå’Œæ¯ä¸ªä½¿ç”¨å®ƒçš„çº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªè®¸å¯ï¼ˆpermitï¼‰å…³è”ï¼Œpermitç›¸å½“äº1ï¼Œ0å¼€å…³ï¼Œé»˜è®¤æ˜¯0ã€‚å¯ä»¥æŠŠè®¸å¯çœ‹æˆæ˜¯ä¸€ç§(0, 1)ä¿¡å·é‡ï¼ˆSemaphoreï¼‰ï¼Œä½†ä¸Semaphoreä¸åŒçš„æ˜¯ï¼Œè®¸å¯çš„ç´¯åŠ ä¸Šé™æ˜¯1ã€‚

è°ƒç”¨unparkå°±åŠ 1ï¼›è°ƒç”¨ä¸€æ¬¡parkå°±ä¼šæ¶ˆè´¹ä¸€ä¸ªpermitï¼Œä¹Ÿå°±æ˜¯å°†1å˜æˆ0ï¼ŒåŒæ—¶parkç«‹åˆ»è¿”å›ã€‚å¦‚æœå†æ¬¡è°ƒç”¨parkä¼šé˜»å¡ï¼Œå› ä¸ºpermitå˜ä¸ºé›¶ä¼šé˜»å¡åœ¨è¿™é‡Œï¼Œç›´åˆ°permitå˜ä¸º1ã€‚permitæœ€å¤§å€¼ä¸º1ï¼Œé‡å¤è°ƒç”¨ä¹Ÿä¸ä¼šç´¯åŠ ã€‚

LockSupport.parkåº•å±‚ï¼š

```java
public static void park() {
	UNSAFE.park(false, 0L);
}
```

LockSupport.unparkåº•å±‚ï¼š

```java
public static void unpark(Thread thread) {
    if (thread != null)
        UNSAFE.unpark(thread);
}
```

ğŸ“ƒ **ä»£ç æ¡ˆä¾‹**

```java
public class LockSupportDemo {
    public static void main(String[] args) {
        Thread t1 = new Thread(() -> {
            System.out.println(Thread.currentThread().getName() + "\t" + "---come inï¼");
            LockSupport.park(); // é˜»å¡ï¼Œç­‰å¾…é€šçŸ¥æ”¾è¡Œï¼Œå®ƒéœ€è¦è®¸å¯è¯
            System.out.println(Thread.currentThread().getName() + "\t" + "---è¢«å”¤é†’ï¼");

        }, "A");
        t1.start();

        Thread t2 = new Thread(() -> {
            System.out.println(Thread.currentThread().getName() + "\t" + "---é€šçŸ¥ï¼");
            LockSupport.unpark(t1);
        }, "B");
        t2.start();
    }
}
```

### 1.3 AQS
#### 1.3.1 ç®€å•ä»‹ç»
AQSï¼ŒAbstractQueuedSynchronizerï¼ŒæŠ½è±¡é˜Ÿåˆ—åŒæ­¥å™¨ï¼Œç”¨æ¥æ„å»ºé”å’ŒåŒæ­¥å™¨çš„**æ¶æ„**ã€‚

>é€šè¿‡AQSæ„å»ºçš„ç»„ä»¶æœ‰ï¼šReentrantLockã€ReentrantReadWriteLockã€Semaphoreã€CountDownLatchã€CyclicBarrier

**AQSæ ¸å¿ƒæ€æƒ³**æ˜¯ï¼Œå¦‚æœè¢«è¯·æ±‚çš„èµ„æºç©ºé—²ï¼Œåˆ™å°†å½“å‰è¯·æ±‚èµ„æºçš„çº¿ç¨‹è®¾ç½®ä¸ºæœ‰æ•ˆå·¥ä½œçº¿ç¨‹ï¼Œå¹¶å°†å…±äº«èµ„æºè®¾ç½®ä¸ºé”å®šçŠ¶æ€ï¼›å¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºè¢«å ç”¨ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å°±è¦æ’é˜Ÿç­‰å¾…èµ„æºçš„é‡Šæ”¾ã€‚

é€šè¿‡æ ¸å¿ƒæ€æƒ³æˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸¤ä¸ªé‡è¦æ¦‚å¿µï¼šå…±äº«èµ„æºçŠ¶æ€ã€é˜Ÿåˆ—ã€‚

- å…±äº«èµ„æºçŠ¶æ€ï¼šç”¨æ¥åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯è¢«å ç”¨è¿˜æ˜¯ç©ºé—²ã€‚
- é˜Ÿåˆ—ï¼šæ²¡æœ‰è·å¾—èµ„æºçš„çº¿ç¨‹å°†æ”¾åˆ°é˜Ÿåˆ—ä¸­ç­‰å¾…ã€‚

![](https://raw.githubusercontent.com/zouquchen/Images/main/imgs2022/AQS1.png)
å…±äº«èµ„æºçš„çŠ¶æ€é€šè¿‡stateå˜é‡è¡¨ç¤ºï¼Œ0è¡¨ç¤ºç©ºé—²ï¼Œ1è¡¨ç¤ºè¢«å ç”¨ï¼Œé€šè¿‡CASæ“ä½œå¯¹å…¶çŠ¶æ€è¿›è¡Œä¿®æ”¹ã€‚

å¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºè¢«å ç”¨ã€‚é‚£ä¹ˆå°†è¯¥çº¿ç¨‹å°è£…åˆ°ä¸€ä¸ªNodeå†…ï¼Œé€šè¿‡CASæ“ä½œæ”¾åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­çš„å°¾éƒ¨è¿›è¡Œæ’é˜Ÿã€‚

ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼ŒCLHé˜Ÿåˆ—æ˜¯ä¸€ä¸ªåŒå‘é˜Ÿåˆ—ï¼Œæˆ–è€…è¯´æ˜¯åŒå‘é“¾è¡¨ï¼Œå¯ä»¥é€šè¿‡å½“å‰èŠ‚ç‚¹è·å–å‰åä¸¤ä¸ªèŠ‚ç‚¹ã€‚
#### 1.3.2 å‚æ•°ä»‹ç»
â­ **AQSè‡ªèº«**

`private volatile int state`ï¼š0è¡¨ç¤ºèµ„æºç©ºé—²ï¼Œçº¿ç¨‹å¯ä»¥ç›´æ¥è·å–ï¼›1è¡¨ç¤ºèµ„æºè¢«å ç”¨ï¼Œçº¿ç¨‹é˜»å¡ç­‰å¾…ã€‚

`CLHé˜Ÿåˆ—`ï¼šä¸‰ä¸ªå¤§ç‰›çš„åå­—ç»„æˆï¼Œä¸ºä¸€ä¸ªåŒå‘é˜Ÿåˆ—ã€‚é€šè¿‡è‡ªé€‰ç­‰å¾…ï¼Œstateå˜é‡åˆ¤æ–­æ˜¯å¦é˜»å¡ï¼Œä»å°¾éƒ¨å…¥é˜Ÿï¼Œä»å¤´éƒ¨å‡ºé˜Ÿã€‚

`private transient volatile Node head`ï¼šå¤´æŒ‡é’ˆ

`private transient volatile Node tail`ï¼šå°¾æŒ‡é’ˆ

â­ **å†…éƒ¨ç±»Node**

ç»„æˆï¼šwaitStatusç­‰å¾…çŠ¶æ€ + å‰åæŒ‡é’ˆ + çº¿ç¨‹

`static final Node SHARED = new Node()`ï¼šè¡¨ç¤ºçº¿ç¨‹ä»¥å…±äº«çš„æ¨¡å¼ç­‰å¾…é”

`static final Node EXCLUSIVE = null`ï¼šè¡¨ç¤ºçº¿ç¨‹ä»¥ç‹¬å çš„æ–¹å¼ç­‰å¾…é”

`volatile Node prev`ï¼šå‰æŒ‡é’ˆ

`volatile Node next`ï¼šåæŒ‡é’ˆ

`volatile int waitStatus`ï¼šé˜»å¡çº¿ç¨‹çš„ç­‰å¾…çŠ¶æ€

- 0ï¼Œé»˜è®¤å€¼
- 1ï¼ŒCANCALLEDï¼Œè¡¨ç¤ºçº¿ç¨‹è·å–é”çš„è¯·æ±‚å·²å–æ¶ˆ
- -2ï¼ŒCONDITIONï¼Œè¡¨èŠ‚ç‚¹åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼ŒèŠ‚ç‚¹çº¿ç¨‹ç­‰å¾…å”¤é†’
- -3ï¼ŒPROPAGATEï¼Œå½“å‰çº¿ç¨‹å¤„äºSHAREDæƒ…å†µä¸‹ï¼Œè¯¥å­—æ®µæ‰ä¼šä½¿ç”¨
- -1ï¼ŒSIGANALï¼Œè¡¨ç¤ºåç»§èŠ‚ç‚¹çš„çº¿ç¨‹éœ€è¦è¢«å”¤é†’ã€‚å½“ä¸€ä¸ªèŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹é‡Šæ”¾é”æˆ–è€…å–æ¶ˆç­‰å¾…æ—¶ï¼Œå®ƒä¼šå°†è‡ªå·±çš„ç­‰å¾…çŠ¶æ€è®¾ç½®ä¸ºSIGNALï¼Œä»¥é€šçŸ¥åç»§èŠ‚ç‚¹éœ€è¦è¢«å”¤é†’ã€‚

`volatile Thread thread`ï¼šé˜»å¡çš„çº¿ç¨‹

![](https://raw.githubusercontent.com/zouquchen/Images/main/imgs2022/AQS2.png)

## 2. æºç è§£è¯»

### 2.1 åˆ†ææ¡ˆä¾‹
ä¸‹é¢ä»¥ä¸€æ®µç®€å•çš„ä»£ç ä¸ºåˆ‡å…¥ç‚¹ï¼Œåˆ†ææ¯ä¸€æ­¥ä»£ç æ˜¯å¦‚ä½•è¿è½¬çš„ã€‚

åœ¨è¯¥æ¡ˆä¾‹ä¸­ï¼Œä¸€å…±æœ‰ä¸‰ä¸ªçº¿ç¨‹å’Œä¸€æŠŠé”ï¼Œå®ƒä»¬å°†ä¾æ¬¡è·å–é”ï¼Œæ‰§è¡Œä»»åŠ¡åé‡Šæ”¾é”ã€‚æˆ‘ä»¬æ¥ä¸‹æ¥å°†åˆ†æï¼š
- å¦‚æœé”æ²¡æœ‰è¢«å ç”¨ï¼Œæ‰§è¡Œ`lock()`åä¼šå‘ç”Ÿä¸Šé¢ï¼Ÿ
- å¦‚æœé”è¢«å ç”¨ï¼Œæ‰§è¡Œ`lock()`åä¼šå‘ç”Ÿä¸Šé¢ï¼Ÿ
- æ‰§è¡Œ`unlock()`åä¼šå‘ç”Ÿä¸Šé¢ï¼Ÿ

```java
public static void main(String[] args) {
    // ReentrantLock éå…¬å¹³é”
    Lock lock = new ReentrantLock();
    
    // çº¿ç¨‹A
    new Thread(() -> {
        lock.lock();
        System.out.println(Thread.currentThread().getName() + "\t" + "å¼€å§‹å·¥ä½œï¼");
        try {  Thread.sleep(2000); } catch (InterruptedException e) { e.printStackTrace(); }
        lock.unlock();
    }, "A").start();
    
    // çº¿ç¨‹B
    new Thread(() -> {
        lock.lock();
        System.out.println(Thread.currentThread().getName() + "\t" + "å¼€å§‹å·¥ä½œï¼");
        try {  Thread.sleep(2000); } catch (InterruptedException e) { e.printStackTrace(); }
        lock.unlock();
    }, "B").start();
    
    // çº¿ç¨‹C
    new Thread(() -> {
        lock.lock();
        System.out.println(Thread.currentThread().getName() + "\t" + "å¼€å§‹å·¥ä½œï¼");
        try {  Thread.sleep(2000); } catch (InterruptedException e) { e.printStackTrace(); }
        lock.unlock();
    }, "C").start();
}
```

### 2.2 å…¬å¹³é”&éå…¬å¹³é”
> å…¬å¹³é”ï¼šå¤šä¸ªçº¿ç¨‹æŒ‰ç…§ç”³è¯·é”çš„é¡ºåºæ¥è·å–é”ï¼Œå…ˆæ¥å…ˆè§£å†³ã€‚
> éå…¬å¹³é”ï¼šå¤šçº¿ç¨‹è·å–é”çš„é¡ºåºå¯èƒ½ä¸æ˜¯æŒ‰ç…§ç”³è¯·é”çš„é¡ºåºï¼Œæœ‰å¯èƒ½åç”³è¯·çš„çº¿ç¨‹æ¯”å…ˆç”³è¯·çš„çº¿ç¨‹ä¼˜å…ˆè·å–é”ã€‚

é¦–å…ˆæ¥çœ‹çœ‹`ReentrantLock`çš„æ„é€ å™¨ï¼š
```java
// åˆ›å»ºä¸€ä¸ªéå…¬å¹³é”çš„å®ä¾‹
public ReentrantLock() {
    sync = new NonfairSync();
}

// æ ¹æ®ä¼ å…¥å‚æ•°åˆ›å»ºå…¬å¹³é”æˆ–éå…¬å¹³é”ï¼Œtrueï¼šå…¬å¹³é”ï¼Œfalseï¼šéå…¬å¹³é”
public ReentrantLock(boolean fair) {
    sync = fair ? new FairSync() : new NonfairSync();
}
```
ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬é€šè¿‡ä¸‹é¢è¿™ä¸ªå‘½ä»¤åˆ›å»ºçš„é”æ˜¯éå…¬å¹³é”ï¼š

```java
Lock lock = new ReentrantLock();
```

### 2.3 Sync
å¯ä»¥çœ‹åˆ°éå…¬å¹³é”`NonfairSync`å’Œå…¬å¹³é”`FairSync`ä¸¤ä¸ªå†…éƒ¨ç±»éƒ½æ˜¯ç»§æ‰¿äº†`Sync`å†…éƒ¨ç±»ã€‚

```java
static final class NonfairSync extends Sync {
	...
}

static final class FairSync extends Sync {
	...
}
```
è€Œ`Sync`è¿™ä¸ªæŠ½è±¡å†…éƒ¨ç±»åˆ™æ˜¯ç»§æ‰¿äº†AQSï¼ˆAQSå°±æ˜¯ä¸€ä¸ªæ¨¡æ¿ï¼‰ã€‚

```java
abstract static class Sync extends AbstractQueuedSynchronizer {
	...
}
```
æ‰€ä»¥è¯´ï¼Œ`ReentrantLock`çš„å®ç°åŸç†å°±æ˜¯`AQS`ã€‚


### 2.4 state=0çŠ¶æ€ä¸‹çš„lock()
ç¬¬ä¸€ä¸ªçº¿ç¨‹å¼€å§‹å·¥ä½œã€ğŸš©æ ‡è®°0ã€‘

```java
// çº¿ç¨‹A
new Thread(() -> {
    lock.lock();
    System.out.println(Thread.currentThread().getName() + "\t" + "å¼€å§‹å·¥ä½œï¼");
    try {  Thread.sleep(2000); } catch (InterruptedException e) { e.printStackTrace(); }
    lock.unlock();
}, "A").start();
```
æ‰§è¡Œç¬¬ä¸€å¥`lock.lock();`

```java
public void lock() {
    sync.lock();
}
```

æœ€ç»ˆä¼šå®šä½åˆ°`NonfairSync`ä¸­çš„`lock()`æ–¹æ³•ã€ğŸš©æ ‡è®°1ã€‘

```java
final void lock() {
    if (compareAndSetState(0, 1))
        setExclusiveOwnerThread(Thread.currentThread());
    else
        acquire(1);
}
```

é¦–å…ˆçœ‹`compareAndSetState(0, 1)`ï¼Œé€šè¿‡åå­—ä¹Ÿå¯ä»¥çœ‹å‡ºå®ƒçš„æ¶µä¹‰ï¼Œé€šè¿‡CASæ“ä½œå°†stateçŠ¶æ€ä»0å˜ä¸º1ã€‚å®ƒçš„å®ç°æ˜¯é€šè¿‡unsafeä¸­çš„æœ¬åœ°æ–¹æ³•æ¥å®ç°çš„ï¼Œç¬¬ä¸€éƒ¨åˆ†å·²ç»ç®€å•ä»‹ç»è¿‡äº†ã€‚

```java
protected final boolean compareAndSetState(int expect, int update) {
    // See below for intrinsics setup to support this
    return unsafe.compareAndSwapInt(this, stateOffset, expect, update);
}
```
å› ä¸ºæ­¤æ—¶èµ„æºç©ºé—²ï¼Œæ‰€ä»¥state=0ï¼Œå› æ­¤CASæ“ä½œæˆåŠŸï¼ŒæˆåŠŸæŠŠèµ„æºçŠ¶æ€stateè®¾ç½®ä¸º1ã€‚**è®°ä½ï¼Œç°åœ¨çš„state=1**ã€‚

å›åˆ°ã€æ ‡è®°1ã€‘çš„ä»£ç ï¼š
```java
final void lock() {
    if (compareAndSetState(0, 1))
        setExclusiveOwnerThread(Thread.currentThread());
    else
        acquire(1);
}
```
ifæ¡ä»¶æˆç«‹ï¼Œæ‰§è¡Œ`setExclusiveOwnerThread(Thread.currentThread())`ï¼Œé€šè¿‡åå­—çœ‹å‡ºå®ƒçš„å«ä¹‰æ˜¯ï¼šå°†å½“å‰çº¿ç¨‹è®¾ç½®ä¸º**æ‹¥æœ‰é”ä¸”æ­£åœ¨æ‰§è¡Œçº¿ç¨‹**ï¼Œä¹Ÿå°±æ˜¯è¯´çº¿ç¨‹Aä¸ºè¿™æŠŠé”çš„æ‹¥æœ‰è€…ã€‚

æ­¤æ—¶`lock.lock()`è¯­å¥æ‰§è¡Œå®Œæ¯•ï¼Œå›åˆ°ã€æ ‡è®°0ã€‘ï¼Œç»§ç»­æ‰§è¡Œä¸‹é¢éƒ¨åˆ†ã€‚

```java
System.out.println(Thread.currentThread().getName() + "\t" + "å¼€å§‹å·¥ä½œï¼");
try {  Thread.sleep(2000); } catch (InterruptedException e) { e.printStackTrace(); }
```

è®°ä½ï¼Œæ­¤æ—¶stateçŠ¶æ€ä¸º1ï¼Œçº¿ç¨‹Aæ‹¥æœ‰è¿™æŠŠé”ã€‚

### 2.5 state=1çŠ¶æ€ä¸‹çš„lock()
ç¬¬äºŒä¸ªçº¿ç¨‹å¼€å§‹å·¥ä½œã€ğŸš©æ ‡è®°2ã€‘

```java
// çº¿ç¨‹B
new Thread(() -> {
    lock.lock();
    System.out.println(Thread.currentThread().getName() + "\t" + "å¼€å§‹å·¥ä½œï¼");
    try {  Thread.sleep(2000); } catch (InterruptedException e) { e.printStackTrace(); }
    lock.unlock();
}, "A").start();
```
ä¸ä¹‹å‰ç›¸åŒï¼Œæ‰§è¡Œç¬¬ä¸€å¥`lock.lock();`

```java
public void lock() {
    sync.lock();
}
```

ä¸ä¹‹å‰ç›¸åŒï¼Œæœ€ç»ˆä¼šå®šä½åˆ°`NonfairSync`ä¸­çš„`lock()`æ–¹æ³•ã€ğŸš©æ ‡è®°3ã€‘
```java
final void lock() {
    if (compareAndSetState(0, 1))
        setExclusiveOwnerThread(Thread.currentThread());
    else
        acquire(1);
}
```
ä¸ä¹‹å‰ç›¸åŒï¼Œæ‰§è¡Œ`compareAndSetState(0, 1)`ï¼Œå¦‚æœstate=0ï¼Œåˆ™é€šè¿‡CASæ“ä½œå°†stateçŠ¶æ€ä»0å˜ä¸º1ï¼Œä½†æ˜¯stateä¸ä¸º0ï¼Œæ‰€ä»¥CASæ“ä½œå¤±è´¥ï¼Œifä¸æˆç«‹ï¼Œæ‰§è¡Œ`acquire(1)`ã€‚

ä¸‹é¢æ¥çœ‹çœ‹`acquire()`æ–¹æ³•ï¼Œä¼ å…¥çš„å‚æ•°arg=1ã€ğŸš©æ ‡è®°4ã€‘
```java
public final void acquire(int arg) {
    if (!tryAcquire(arg) && acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
        selfInterrupt();
}
```
å…ˆçœ‹`tryAcquire(arg)`æ–¹æ³•ï¼Œæ‰¾åˆ°å®ƒåœ¨AQSä¸­çš„æ–¹æ³•ï¼Œå¦‚æœè°ƒç”¨AQSä¸­çš„æ–¹æ³•ä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œæ‰€ä»¥å­ç±»å¿…é¡»è¦é‡å†™è¿™ä¸ªæ–¹æ³•ã€‚å¦‚æœæˆ‘ä»¬è¦ä½¿ç”¨AQSæ¨¡æ¿è‡ªå®šä¹‰ä¸€äº›åŠŸèƒ½çš„è¯ï¼Œå¿…é¡»è¦é‡å†™è¿™ä¸ªæ–¹æ³•ã€‚

```java
protected boolean tryAcquire(int arg) {
    throw new UnsupportedOperationException();
}
```

æˆ‘ä»¬æ‰¾åˆ°å®ƒåœ¨`NonfairSync`ä¸­çš„å®ç°ã€‚

```java
protected final boolean tryAcquire(int acquires) {
    return nonfairTryAcquire(acquires);
}
```
å®ƒåˆè°ƒç”¨äº†`Sync`ä¸­`çš„nonfairTryAcquire(acquires)`æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´ã€æ ‡è®°4ã€‘ä¸­çš„`tryAcquire(arg)`å…¶å®å°±æ˜¯`nonfairTryAcquire(int acquires)`æ–¹æ³•ã€‚

```java
final boolean nonfairTryAcquire(int acquires) { // æ­¤æ—¶ acquires = 1
	// è·å–å½“å‰çº¿ç¨‹ï¼Œå½“å‰çº¿ç¨‹æ˜¯Bçº¿ç¨‹
    final Thread current = Thread.currentThread();
    // è·å–stateçŠ¶æ€ï¼Œå‰é¢æˆ‘ä»¬åå¤å¼ºè°ƒäº†ï¼Œstateçš„çŠ¶æ€ä¸º1ï¼Œè¡¨ç¤ºè¢«å ç”¨ï¼ˆå½“å‰è¢«çº¿ç¨‹Aå ç”¨ï¼‰
    int c = getState();
    // state=1ï¼Œifæ¡ä»¶ä¸æˆç«‹
    if (c == 0) {
        if (compareAndSetState(0, acquires)) {
            setExclusiveOwnerThread(current);
            return true;
        }
    }
    // åˆ¤æ–­å½“å‰çš„çº¿ç¨‹æ˜¯ä¸æ˜¯æ‹¥æœ‰è¿™ä¸ªé”çš„çº¿ç¨‹ï¼Œè¿™ä¸ªåœ°æ–¹æ˜¯åˆ¤æ–­å¯é‡å…¥
    // æ‹¥æœ‰é”çš„çº¿ç¨‹æ˜¯Aï¼Œå½“å‰çº¿ç¨‹æ˜¯Bï¼Œæ‰€ä»¥else ifä¸æˆç«‹
    else if (current == getExclusiveOwnerThread()) {
        int nextc = c + acquires;
        if (nextc < 0) // overflow
            throw new Error("Maximum lock count exceeded");
        setState(nextc);
        return true;
    }
    // æœ€ååªèƒ½è¿”å›false
    return false;
}
```

ç»è¿‡å‰é¢çš„åˆ¤æ–­ï¼Œæˆ‘ä»¬çŸ¥é“äº†å½“å‰state=1ï¼Œè¢«å…¶ä»–çº¿ç¨‹å ç”¨ï¼›åŒæ—¶ï¼Œè¯¥çº¿ç¨‹ä¸æ˜¯æ‹¥æœ‰è¿™ä¸ªé”çš„çº¿ç¨‹ï¼Œä¸å¯é‡å…¥ï¼Œå°†è¿”å›falseã€‚

*ã€æ ‡è®°4ã€‘çš„ä»£ç ï¼ˆé‡æ–°å†™ä¸€ä¸‹ï¼Œè¿™æ ·å°±ä¸ç”¨å¾€ä¸Šç¿»äº†ï¼‰*

```java
public final void acquire(int arg) {
    if (!tryAcquire(arg) && acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
        selfInterrupt();
}
```
ä¹Ÿå°±æ˜¯è¯´ã€æ ‡è®°4ã€‘ä¸­çš„`tryAcquire(arg)`ä¸ºfalseï¼Œé‚£ä¹ˆ`!tryAcquire(arg)`ä¸ºtrueï¼Œæ¥ä¸‹æ¥å°±åº”è¯¥å°†è¯¥çº¿ç¨‹æ”¾åˆ°é˜Ÿåˆ—ä¸­ç­‰å¾…èµ„æºçš„é‡Šæ”¾ã€‚ç»§ç»­çœ‹ä¸‹é¢çš„æ¡ä»¶
```java
acquireQueued(addWaiter(Node.EXCLUSIVE), arg)
```
å…¶ä¸­åŒ…å«ä¸¤ä¸ªæ–¹æ³•`acquireQueued()`å’Œ`addWaiter()`

æˆ‘ä»¬å…ˆçœ‹`addWaiter(Node.EXCLUSIVE)` ã€ğŸš©æ ‡è®°5ã€‘

```java
private Node addWaiter(Node mode) {
	// æŠŠå½“å‰çº¿ç¨‹å°è£…æˆä¸€ä¸ªNodeèŠ‚ç‚¹ï¼Œè¿™æ˜¯AQSé‡Œé¢çš„çŸ¥è¯†ç‚¹ã€‚
	// ä¼ å…¥çš„modeä¸ºNode.EXCLUSIVEï¼Œè¡¨ç¤ºç‹¬å é”
	// Semaphoreã€CountDownLatchä½¿ç”¨Node.SHARED
    Node node = new Node(Thread.currentThread(), mode);
    // Try the fast path of enq; backup to full enq on failure
    // è·å¾—CLHé˜Ÿåˆ—ä¸­çš„ä¸ºå°¾èŠ‚ç‚¹ï¼ˆæœªè·å–å…±äº«èµ„æºçš„çº¿ç¨‹å°è£…ä¸ºNodeèŠ‚ç‚¹æ”¾åˆ°è¿™ä¸ªCLHé˜Ÿåˆ—ä¸­ç­‰å¾…ï¼‰
    Node pred = tail;
    // åˆ¤æ–­å°¾èŠ‚ç‚¹æ˜¯å¦å°¾null
    // å½“å‰çº¿ç¨‹å°è£…åŸçš„èŠ‚ç‚¹æ˜¯ç¬¬ä¸€ä¸ªåŠ å…¥åˆ°é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹ï¼Œæ­¤æ—¶å°¾èŠ‚ç‚¹ä¸ºnullï¼Œifæ¡ä»¶ä¸æˆç«‹ã€‚
    if (pred != null) {
        node.prev = pred;
        if (compareAndSetTail(pred, node)) {
            pred.next = node;
            return node;
        }
    }
    // å°¾èŠ‚ç‚¹å°¾nullï¼Œè·³åˆ°è¿™é‡Œ
    enq(node);
    return node;
}
```
ç»è¿‡åˆ†æï¼Œæ­¤æ—¶å°¾èŠ‚ç‚¹`pred`(ä¹Ÿå°±æ˜¯`tail`)ä¸º`null`ï¼Œè°ƒç”¨æ–¹æ³•`enq(node)`ã€ğŸš©æ ‡è®°6ã€‘

```java
private Node enq(final Node node) {
	// for (;;)ç­‰ä»·äºwhile(true), ä¸€ç›´å¾ªç¯
    for (;;) {
        Node t = tail; 
        if (t == null) { // Must initialize
            if (compareAndSetHead(new Node()))
                tail = head;
        } else {
            node.prev = t;
            if (compareAndSetTail(t, node)) {
                t.next = node;
                return t;
            }
        }
    }
}
```
æ‰§è¡Œç¬¬ä¸€é`enq`æ–¹æ³•

```java
// è·å–å°¾èŠ‚ç‚¹ï¼Œæ­¤æ—¶ t = tail = null
Node t = tail; 
// ifæˆç«‹
if (t == null) { // Must initialize
	// åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºèŠ‚ç‚¹ï¼Œé€šè¿‡CASæ“ä½œæŠŠä»–è®¾ç½®ä¸ºå¤´ç»“ç‚¹
	// è¿™ä¸€æ­¥ä¼šè®¾ç½®æˆåŠŸ
    if (compareAndSetHead(new Node()))
    	// è®¾ç½®æˆåŠŸåï¼Œä»¤å°¾èŠ‚ç‚¹ç­‰äºå¤´ç»“ç‚¹
        tail = head;
        // è‡³æ­¤ï¼Œç¬¬ä¸€éå¾ªç¯ç»“æŸ
} else {
    node.prev = t;
    if (compareAndSetTail(t, node)) {
        t.next = node;
        return t;
    }
}
```
ã€æ ‡è®°6ã€‘ä¸­è¯´äº†`for (;;)`è¡¨ç¤ºä¸€ç›´å¾ªç¯ï¼Œç°åœ¨è¿˜æ²¡æœ‰è·³å‡ºå¾ªç¯ï¼Œæ‰€ä»¥ä¸‹é¢æ¥çœ‹ç¬¬äºŒéå¾ªç¯

```java
// è·å–å°¾èŠ‚ç‚¹ï¼Œæ­¤æ—¶ t = tail = head = ä¸€ä¸ªç©ºçš„èŠ‚ç‚¹ï¼ˆå“¨å…µèŠ‚ç‚¹ï¼‰
Node t = tail; 
// ifæ¡ä»¶ä¸æˆç«‹
if (t == null) { // Must initialize
    if (compareAndSetHead(new Node()))
        tail = head;
// elseæˆç«‹
} else {
	// nodeèŠ‚ç‚¹æ˜¯ä¼ å…¥çš„å‚æ•°ï¼Œä¹Ÿå°±æ˜¯å°è£…äº†çº¿ç¨‹Bçš„èŠ‚ç‚¹
	// è®©tèŠ‚ç‚¹ä½œä¸ºnodeèŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹ã€‚
    node.prev = t;
    // é€šè¿‡CASæ“ä½œå°†nodeèŠ‚ç‚¹è®¾ç½®ä¸ºå°¾èŠ‚ç‚¹
    // è¯¥æ“ä½œèƒ½æˆåŠŸ
    if (compareAndSetTail(t, node)) {
    	// ç”±äºè¿™æ˜¯åŒå‘é“¾è¡¨ï¼Œnodeè®¾ç½®æˆå°¾èŠ‚ç‚¹åï¼Œå°†nodeè®¾ç½®å°¾tèŠ‚ç‚¹çš„åç½®èŠ‚ç‚¹
        t.next = node;
        // æœ€åè¿”å›tèŠ‚ç‚¹ï¼Œè¿”å›å€¼ç”¨ä¸ä¸Šã€‚
        return t;
    }
}
```
é€šè¿‡ä¸¤æ¬¡å¾ªç¯ï¼Œæˆ‘ä»¬åˆå§‹åŒ–äº†è¿™ä¸ªé˜Ÿåˆ—ï¼Œä¸ºé˜Ÿåˆ—åˆ›å»ºäº†ä¸€ä¸ªå¤´ç»“ç‚¹ï¼Œå¹¶å°†å½“å‰èŠ‚ç‚¹nodeè®¾ç½®å°¾å°¾èŠ‚ç‚¹ã€‚ä¹Ÿå°±æ˜¯è¯´ã€æ ‡è®°6ã€‘`enq(node)`çš„ä½œç”¨å°±æ˜¯åˆå§‹åŒ–é˜Ÿåˆ—ï¼Œå¹¶å°†å½“å‰èŠ‚ç‚¹è®¾ç½®ä¸ºå°¾èŠ‚ç‚¹ã€‚

æˆ‘ä»¬å›åˆ°ã€æ ‡è®°5ã€‘`addWaiter(Node.EXCLUSIVE)` ï¼Œå°†nodeèŠ‚ç‚¹å…¥é˜Ÿåè¿”å›nodeèŠ‚ç‚¹ã€‚

```java
private Node addWaiter(Node mode) {
	...
    // å°¾èŠ‚ç‚¹å°¾nullï¼Œè·³åˆ°è¿™é‡Œ
    enq(node);
    return node;
}
```

æˆ‘ä»¬å†å›åˆ°ã€æ ‡è®°4ã€‘çš„ä»£ç ï¼Œ`addWaiter(Node.EXCLUSIVE)`è¿”å›èŠ‚ç‚¹nodeï¼ˆé‡Œé¢å°è£…äº†çº¿ç¨‹Bï¼‰

```java
public final void acquire(int arg) {
    if (!tryAcquire(arg) && acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
        selfInterrupt();
}
```
ä¸‹é¢å°†è°ƒç”¨æ–¹æ³•`acquireQueued(node, arg)`ã€ğŸš©æ ‡è®°7ã€‘

```java
final boolean acquireQueued(final Node node, int arg) {
    boolean failed = true;
    try {
    	// è¡¨ç¤ºè¯¥çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ï¼Œ
        boolean interrupted = false;
        // æ­»å¾ªç¯
        for (;;) {
            final Node p = node.predecessor();
            if (p == head && tryAcquire(arg)) {
                setHead(node);
                p.next = null; // help GC
                failed = false;
                return interrupted;
            }
            if (shouldParkAfterFailedAcquire(p, node) &&
                parkAndCheckInterrupt())
                interrupted = true;
        }
    } finally {
        if (failed)
            cancelAcquire(node);
    }
}
```
ç”±äºå…¶ä¸­åŒ…å«`for (;;)`ï¼Œå°†æ‰§è¡Œå¤šæ¬¡ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ç¬¬ä¸€æ¬¡å¾ªç¯ã€ğŸš©æ ‡è®°8ã€‘ï¼š

```java
// è·å–å½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹
// æ­¤æ—¶CLHä¸­åªæœ‰ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œå½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹å°±æ˜¯å¤´ç»“ç‚¹head
final Node p = node.predecessor();
// p == headæˆç«‹
// tryAcquire(arg)å‚è€ƒã€æ ‡è®°4ã€‘ï¼Œå†æ¬¡å°è¯•è·å–çº¿ç¨‹ï¼Œä½†è¿˜æ˜¯è·å–å¤±è´¥äº†ï¼Œè¿”å›false
// æ‰€ä»¥å½“å‰ifä¸æˆç«‹
if (p == head && tryAcquire(arg)) {
    setHead(node);
    p.next = null; // help GC
    failed = false;
    return interrupted;
}
// ä¸Šé¢çš„ifä¸æˆç«‹ï¼Œå†çœ‹çœ‹è¿™ä¸ªif
if (shouldParkAfterFailedAcquire(p, node) && parkAndCheckInterrupt())
    interrupted = true;
```
è¿™ä¸ªifä¸­åŒ…å«äº†ä¸¤ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹`shouldParkAfterFailedAcquire(p, node)`ã€ğŸš©æ ‡è®°9ã€‘

pæ˜¯å¤´ç»“ç‚¹ï¼Œnodeæ˜¯å½“å‰èŠ‚ç‚¹ï¼ˆå°è£…çº¿ç¨‹Bçš„èŠ‚ç‚¹ï¼‰

> waitStatusï¼šAQSçŸ¥è¯†ç‚¹ã€è¯¦æƒ…è§1.3.2ã€‘ï¼ŒåŒ…å«äº”ç§çŠ¶æ€ï¼š
> - 0ï¼Œé»˜è®¤å€¼
> - 1ï¼ŒCANCALLEDï¼Œè¡¨ç¤ºçº¿ç¨‹è·å–é”çš„è¯·æ±‚å·²å–æ¶ˆ
> - -2ï¼ŒCONDITIONï¼Œè¡¨èŠ‚ç‚¹åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼ŒèŠ‚ç‚¹çº¿ç¨‹ç­‰å¾…å”¤é†’
> - -3ï¼ŒPROPAGATEï¼Œå½“å‰çº¿ç¨‹å¤„äºSHAREDæƒ…å†µä¸‹ï¼Œè¯¥å­—æ®µæ‰ä¼šä½¿ç”¨
> - -1ï¼ŒSIGANALï¼Œè¡¨ç¤ºçº¿ç¨‹å·²ç»å‡†å¤‡å¥½äº†ï¼Œå°±ç­‰èµ„æºé‡Šæ”¾äº†

é€šè¿‡åå­—çœ‹å‡ºå®ƒçš„åŠŸèƒ½æ˜¯ï¼šè·å–èµ„æºå¤±è´¥ï¼Œåº”è¯¥é˜»å¡çº¿ç¨‹ã€‚
```java
private static boolean shouldParkAfterFailedAcquire(Node pred, Node node) {
	// predæ˜¯å¤´ç»“ç‚¹ï¼Œnodeæ˜¯å½“å‰èŠ‚ç‚¹
	// è·å–predå¤´ç»“ç‚¹çš„ï¼ŒwaitStatusçŠ¶æ€ï¼Œå½“å‰å¤´ç»“ç‚¹ä¸ºåˆå§‹åŒ–çš„é»˜è®¤å€¼0
    int ws = pred.waitStatus;
    // ä¸æˆç«‹
    if (ws == Node.SIGNAL)
        return true;
    // ä¸æˆç«‹
    if (ws > 0) {
        do {
            node.prev = pred = pred.prev;
        } while (pred.waitStatus > 0);
        pred.next = node;
    // æˆç«‹
    } else {
    	// åŒCASæ“ä½œå°†ï¼ŒpredèŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯å¤´ç»“ç‚¹çš„çŠ¶æ€ä»0å˜ä¸ºNode.SIGNALï¼ˆ-1ï¼‰
        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);
    }
    // è¿”å›false
    return false;
}
```
å›åˆ°ã€æ ‡è®°8ã€‘

```java
// è·å–å½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹
// æ­¤æ—¶CLHä¸­åªæœ‰ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œå½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹å°±æ˜¯å¤´ç»“ç‚¹head
final Node p = node.predecessor();
// p == headæˆç«‹
// tryAcquire(arg)å‚è€ƒã€æ ‡è®°4ã€‘ï¼Œå†æ¬¡å°è¯•è·å–çº¿ç¨‹ï¼Œä½†è¿˜æ˜¯è·å–å¤±è´¥äº†ï¼Œè¿”å›false
// æ‰€ä»¥å½“å‰ifä¸æˆç«‹
if (p == head && tryAcquire(arg)) {
    setHead(node);
    p.next = null; // help GC
    failed = false;
    return interrupted;
}
// ä¸Šé¢çš„ifä¸æˆç«‹ï¼Œå†çœ‹çœ‹è¿™ä¸ªif
if (shouldParkAfterFailedAcquire(p, node) && parkAndCheckInterrupt())
    interrupted = true;
```
`shouldParkAfterFailedAcquire(p, node)`ä¸ºfalseï¼Œifæ¡ä»¶ä¸æˆç«‹ã€‚ã€æ ‡è®°7ã€‘ä¸­çš„ç¬¬ä¸€éå¾ªç¯ç»“æŸï¼Œä¸‹é¢å¼€å§‹ç¬¬äºŒéå¾ªç¯ã€‚ã€ğŸš©æ ‡è®°10ã€‘
```java
// è·å–å½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹
// æ­¤æ—¶CLHä¸­åªæœ‰ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œå½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹è¿˜æ˜¯å¤´ç»“ç‚¹head
final Node p = node.predecessor();
// p == headæˆç«‹
// tryAcquire(arg)å‚è€ƒã€æ ‡è®°4ã€‘ï¼Œå†æ¬¡å°è¯•è·å–çº¿ç¨‹ï¼Œä½†è¿˜æ˜¯è·å–å¤±è´¥äº†ï¼Œè¿”å›false
// æ‰€ä»¥å½“å‰ifä¸æˆç«‹
if (p == head && tryAcquire(arg)) {
    setHead(node);
    p.next = null; // help GC
    failed = false;
    return interrupted;
}
// ä¸Šé¢çš„ifä¸æˆç«‹ï¼Œå†çœ‹çœ‹è¿™ä¸ªif
if (shouldParkAfterFailedAcquire(p, node) && parkAndCheckInterrupt())
    interrupted = true;
```
æ­¤æ—¶åˆä¸€æ¬¡è°ƒç”¨`shouldParkAfterFailedAcquire(p, node)`æ–¹æ³•

ä¸ã€æ ‡è®°9ä¸€æ ·ã€‘ï¼Œåªä¸è¿‡wsçš„å€¼å‘ç”Ÿäº†æ”¹å˜ï¼Œåœ¨ã€æ ‡è®°9ã€‘ä¸­ï¼Œå°†wsçš„å€¼ä»0è®¾ç½®ä¸ºNode.SIGNALï¼ˆ-1ï¼‰ï¼Œåé¢çš„è¿è¡Œçš„ç»“æœå°†å‘ç”Ÿæ”¹å˜ã€‚

```java
private static boolean shouldParkAfterFailedAcquire(Node pred, Node node) {
	// predæ˜¯å¤´ç»“ç‚¹ï¼Œnodeæ˜¯å½“å‰èŠ‚ç‚¹
	// è·å–predå¤´ç»“ç‚¹çš„ï¼ŒwaitStatusçŠ¶æ€ï¼Œå½“å‰å¤´ç»“ç‚¹ä¸ºNode.SIGNALï¼ˆ-1ï¼‰
    int ws = pred.waitStatus;
    // æˆç«‹
    if (ws == Node.SIGNAL)
    	// è¿”å›true
        return true;
    if (ws > 0) {
        do {
            node.prev = pred = pred.prev;
        } while (pred.waitStatus > 0);
        pred.next = node;
    } else {
        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);
    }
    return false;
}
```
æ­¤æ—¶å°†è¿”å›trueï¼Œå›åˆ°ã€æ ‡è®°10ã€‘ï¼Œ`shouldParkAfterFailedAcquire(p, node)`çš„ç»“æœå°±æ˜¯true

```java
// è·å–å½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹
// æ­¤æ—¶CLHä¸­åªæœ‰ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œå½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹è¿˜æ˜¯å¤´ç»“ç‚¹head
final Node p = node.predecessor();
// p == headæˆç«‹
// tryAcquire(arg)å‚è€ƒã€æ ‡è®°4ã€‘ï¼Œå†æ¬¡å°è¯•è·å–çº¿ç¨‹ï¼Œä½†è¿˜æ˜¯è·å–å¤±è´¥äº†ï¼Œè¿”å›false
// æ‰€ä»¥å½“å‰ifä¸æˆç«‹
if (p == head && tryAcquire(arg)) {
    setHead(node);
    p.next = null; // help GC
    failed = false;
    return interrupted;
}
// ä¸Šé¢çš„ifä¸æˆç«‹ï¼Œå†çœ‹çœ‹è¿™ä¸ªif
if (shouldParkAfterFailedAcquire(p, node) && parkAndCheckInterrupt())
    interrupted = true;
```
ä¸‹é¢çœ‹çœ‹`parkAndCheckInterrupt()`æ–¹æ³•ã€ğŸš©æ ‡è®°11ã€‘

```java
private final boolean parkAndCheckInterrupt() {
	// é˜»å¡å½“å‰çº¿ç¨‹
    LockSupport.park(this);  // å°†ä¸€ç›´å¡åœ¨è¿™é‡Œ
    return Thread.interrupted();
}
```

è¿™ä¸ªåœ°æ–¹è°ƒç”¨äº†`LockSupport.park(this)`æ–¹æ³•é˜»å¡å½“å‰çº¿ç¨‹ï¼ŒLockSupportå‚è€ƒã€1.2ã€‘ã€‚

æ­¤æ—¶çº¿ç¨‹Bå®Œæˆäº†å…¥é˜Ÿç­‰å¾…å’Œé˜»å¡çš„æ“ä½œï¼Œæ­¤æ—¶å°†ä¸€ç›´é˜»å¡åœ¨è¿™é‡Œï¼Œç›´åˆ°ä¸Šä¸€ä¸ªçº¿ç¨‹é‡Šæ”¾èµ„æºï¼Œå¹¶é€šçŸ¥å”¤é†’çº¿ç¨‹Bã€‚æˆ‘ä»¬è®°ä½è¿™ä¸ªã€æ ‡è®°11ã€‘ï¼Œåé¢é€šçŸ¥å”¤é†’çº¿ç¨‹Båå°†å›åˆ°è¿™é‡Œã€‚

åŒç†ï¼Œçº¿ç¨‹Cåœ¨æ‰§è¡Œ`lock.lock()`æ–¹æ³•çš„æ—¶å€™ï¼Œä¹Ÿä¼šç»è¿‡ä¸Šé¢çš„è¿‡ç¨‹ï¼Œçº¿ç¨‹Cå°è£…æˆçš„nodeèŠ‚ç‚¹æ’åœ¨æœ€åé¢ä½œä¸ºå°¾èŠ‚ç‚¹ï¼Œç°åœ¨é˜Ÿåˆ—çš„çŠ¶æ€å¦‚ä¸‹å›¾ï¼š

> çº¿ç¨‹Cåœ¨æ·»åŠ èŠ‚ç‚¹çš„æ—¶å€™ä¸ä¼šåœ¨æ‰§è¡Œ ã€æ ‡è®°5ã€‘ä¸­`enq()`æ–¹æ³•ï¼Œå› ä¸ºå¤´ç»“ç‚¹å·²ç»å®Œæˆäº†åˆå§‹åŒ–ã€‚

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://raw.githubusercontent.com/zouquchen/Images/main/imgs2022/AQS-Queue-Node.png)



### 2.6 unlock()
æ­¤æ—¶å›åˆ°ã€æ ‡è®°0ã€‘çº¿ç¨‹Açš„å®šä¹‰çš„ä½ç½®ï¼Œå‡è®¾ç°åœ¨çº¿ç¨‹å·²ç»å®Œæˆäº†ä»»åŠ¡ï¼Œæ‰§è¡Œ`lock.unlock()`é‡Šæ”¾é”ã€‚

```java
// çº¿ç¨‹A
new Thread(() -> {
    lock.lock();
    System.out.println(Thread.currentThread().getName() + "\t" + "å¼€å§‹å·¥ä½œï¼");
    try {  Thread.sleep(2000); } catch (InterruptedException e) { e.printStackTrace(); }
    lock.unlock();
}, "A").start();
```

ä¸‹é¢çœ‹çœ‹`lock.unlock()`æ–¹æ³•åœ¨`ReentrantLock`ä¸­çš„å®ç°ï¼š

```java
public void unlock() {
    sync.release(1);
}
```

è°ƒç”¨äº†syncçš„releaseæ–¹æ³•ï¼Œä¸‹é¢çœ‹çœ‹`release()`æ–¹æ³•ã€ğŸš©æ ‡è®°12ã€‘

```java
public final boolean release(int arg) {
    if (tryRelease(arg)) { // å…ˆæ‰§è¡ŒtryRelease(1)
        Node h = head;
        if (h != null && h.waitStatus != 0)
            unparkSuccessor(h);
        return true;
    }
    return false;
}
```
å…ˆæ‰§è¡Œ`tryRelease(1)`æ–¹æ³•ï¼Œæ‰¾åˆ°ä»–åœ¨`Sync`ä¸­çš„å®ç°ã€ğŸš©æ ‡è®°13ã€‘

```java
protected final boolean tryRelease(int releases) {
	// è·å–å½“å‰çº¿ç¨‹çŠ¶æ€state=1
	// c = 1 - 1 ä¸º 0
    int c = getState() - releases;
    // åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯ä¸æ˜¯é”çš„æ‹¥æœ‰è€…
    // Açº¿ç¨‹æ‹¥æœ‰è¿™æŠŠé”ï¼Œifä¸æˆç«‹
    if (Thread.currentThread() != getExclusiveOwnerThread())
        throw new IllegalMonitorStateException();
    boolean free = false;
    // ifæˆç«‹
    if (c == 0) {
        free = true;
        // è®¾ç½®å½“å‰æ‹¥æœ‰è¿™æŠŠé”çš„çº¿ç¨‹ä¸º null ï¼Œè¡¨ç¤ºç°åœ¨æ²¡æœ‰çº¿ç¨‹å ç”¨äº†
        setExclusiveOwnerThread(null);
    }
    // å°†stateè®¾ç½®ä¸º0ï¼Œè¡¨ç¤ºå½“å‰èµ„æºç©ºé—²ï¼ˆé”æ²¡æœ‰è¢«å ç”¨ï¼‰
    setState(c);
    // è¿”å›true
    return free;
}
```

é€šè¿‡`tryRelease()`æ–¹æ³•ï¼Œå°†stateçŠ¶æ€ä»1å˜ä¸ºäº†0ï¼Œå½“å‰å ç”¨çš„çº¿ç¨‹ä»ã€çº¿ç¨‹Aã€‘å˜ä¸ºã€nullã€‘ï¼Œæ­¤æ—¶è¿™æŠŠé”å·²ç»è¢«é‡Šæ”¾äº†ã€‚å›åˆ°ã€æ ‡è®°12ã€‘

```java
public final boolean release(int arg) {
    if (tryRelease(arg)) { // tryReleaseè¿”å›trueï¼Œæ¡ä»¶æˆç«‹
        Node h = head;
        // å¤´ç»“ç‚¹ä¸ä¸ºnullï¼Œ åœ¨ã€æ ‡è®°9ã€‘å°†å¤´ç»“ç‚¹çš„waitStatusè®¾ç½®ä¸ºNode.SIGNALï¼ˆ-1ï¼‰
        // æ­¤æ—¶æ¡ä»¶æˆç«‹
        if (h != null && h.waitStatus != 0)
            unparkSuccessor(h); // æ‰§è¡Œæ–¹æ³•unparkSuccessor(h)
        return true;
    }
    return false;
}
```

æ‰§è¡Œ`unparkSuccessor(h)`ï¼Œhæ˜¯å¤´ç»“ç‚¹ã€‚ã€ğŸš©æ ‡è®°14ã€‘

```java
    private void unparkSuccessor(Node node) {
    	// è·å¾—å¤´ç»“ç‚¹çš„ws = Node.SIGNALï¼ˆ-1ï¼‰
        int ws = node.waitStatus;
        // æ¡ä»¶æˆç«‹
        if (ws < 0)
        	// é€šè¿‡CASçš„æ–¹å¼å°†å¤´ç»“ç‚¹çš„wsè®¾ç½®ä¸º0
            compareAndSetWaitStatus(node, ws, 0);
            
        // è·å¾—å¤´ç»“ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå°±æ˜¯çº¿ç¨‹Bå°è£…æˆçš„NodeèŠ‚ç‚¹
        Node s = node.next;
        // è¯¥èŠ‚ç‚¹ä¸ä¸ºnullï¼Œwsä¸º0
        // æ¡ä»¶ä¸æˆç«‹
        if (s == null || s.waitStatus > 0) {
            s = null;
            for (Node t = tail; t != null && t != node; t = t.prev)
                if (t.waitStatus <= 0)
                    s = t;
        }
        
        // sä¸ä¸ºnullï¼Œæˆç«‹
        if (s != null)
        	// é€šè¿‡unparkæ–¹æ³•å”¤é†’èŠ‚ç‚¹å¯¹åº”çš„çº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹B
            LockSupport.unpark(s.thread);
    }
```
é€šè¿‡`unparkSuccessor(h)`æ–¹æ³•ï¼Œæˆ‘ä»¬æˆåŠŸå”¤é†’äº†é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹å°è£…çš„çº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹Bã€‚è®°ä½ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå”¤é†’äº†çº¿ç¨‹Bã€‚

å†æ¬¡å›åˆ°ã€æ ‡è®°12ã€‘ï¼Œè¿”å›trueï¼Œä¸è¿‡è¿™ä¸ªè¿”å›ç»“æœæ²¡ä»€ä¹ˆç”¨ã€‚
```java
public final boolean release(int arg) {
    if (tryRelease(arg)) { 
        Node h = head;
        if (h != null && h.waitStatus != 0)
            unparkSuccessor(h); // è¯¥æ”¾æ³•æ‰§è¡Œå®Œæ¯•
        // è¿”å›true
        return true;
    }
    return false;
}
```
è‡³æ­¤ï¼Œ`lock.unlock()`æ–¹æ³•è¿è¡Œå®Œæ¯•ã€‚

### 2.7 é˜»å¡çº¿ç¨‹è¢«å”¤é†’
å›åˆ°ã€æ ‡è®°11ã€‘ï¼Œçº¿ç¨‹Bè¢«é˜»å¡
```java
private final boolean parkAndCheckInterrupt() {
	// é˜»å¡å½“å‰çº¿ç¨‹
    LockSupport.park(this);  // å°†ä¸€ç›´å¡åœ¨è¿™é‡Œ
    return Thread.interrupted();
}
```

å›åˆ°ã€æ ‡è®°14ã€‘ï¼Œåœ¨è¿™é‡Œé‡Šæ”¾äº†çº¿ç¨‹B
```java
    private void unparkSuccessor(Node node) {
    	... 
        // sä¸ä¸ºnullï¼Œæˆç«‹
        if (s != null)
        	// é€šè¿‡unparkæ–¹æ³•å”¤é†’èŠ‚ç‚¹å¯¹åº”çš„çº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹B
            LockSupport.unpark(s.thread);
    }
```

æ‰€ä»¥ï¼Œæ­¤æ—¶çº¿ç¨‹BæˆåŠŸè¢«å”¤é†’ï¼Œæˆ‘ä»¬å›åˆ°ã€æ ‡è®°11ã€‘ç»§ç»­è¿è¡Œ
```java
private final boolean parkAndCheckInterrupt() {
	// é˜»å¡å½“å‰çº¿ç¨‹
    LockSupport.park(this); 
    // çº¿ç¨‹bæ²¡æœ‰è¢«ä¸­æ–­ï¼Œæ‰€ä»¥è¿”å›false
    return Thread.interrupted(); 
}
```

å›åˆ°ã€æ ‡è®°7ã€‘

```java
final boolean acquireQueued(final Node node, int arg) {
    boolean failed = true;
    try {
    	// è¡¨ç¤ºè¯¥çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ï¼Œ
        boolean interrupted = false;
        // æ­»å¾ªç¯
        for (;;) {
            final Node p = node.predecessor();
            if (p == head && tryAcquire(arg)) {
                setHead(node);
                p.next = null; // help GC
                failed = false;
                return interrupted;
            }
            // å› ä¸ºparkAndCheckInterrupt()è¿”å›falseï¼Œæ‰€ä»¥è¿™é‡Œçš„ifæ¡ä»¶ä¸æˆç«‹
            if (shouldParkAfterFailedAcquire(p, node) &&
                parkAndCheckInterrupt())
                interrupted = true;
        }
    } finally {
        if (failed)
            cancelAcquire(node);
    }
}
```
æˆ‘ä»¬ç»§ç»­é‡Œé¢çš„æ­»å¾ªç¯ã€ğŸš©æ ‡è®°15ã€‘

```java
for (;;) {
	// è·å¾—nodeèŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯å¤´ç»“ç‚¹
    final Node p = node.predecessor();
    // p == headæˆç«‹
    // æˆ‘ä»¬å†å»çœ‹çœ‹tryAcquire(1)æ–¹æ³•
    if (p == head && tryAcquire(arg)) {
        setHead(node);
        p.next = null; // help GC
        failed = false;
        return interrupted;
    }
    // å› ä¸ºparkAndCheckInterrupt()è¿”å›falseï¼Œæ‰€ä»¥è¿™é‡Œçš„ifæ¡ä»¶ä¸æˆç«‹
    if (shouldParkAfterFailedAcquire(p, node) &&
        parkAndCheckInterrupt())
        interrupted = true;
}
```
ä¸‹é¢å†çœ‹çœ‹`tryAcquire(arg)`æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¹‹å‰å·²ç»çœ‹è¿‡äº†ä¸¤æ¬¡ï¼Œæ¯ä¸€æ¬¡éƒ½è¿”å›falseã€‚

```java
final boolean nonfairTryAcquire(int acquires) {
	// è·å–å½“å‰çº¿ç¨‹
    final Thread current = Thread.currentThread();
    // è·å–stateçŠ¶æ€ = 0
    int c = getState();
    // æ¡ä»¶æˆç«‹
    if (c == 0) {
    	// é€šè¿‡CASæ“ä½œï¼Œå°†stateçŠ¶æ€ä»0å˜ä¸º1ï¼Œæ“ä½œä¸€å®šæˆåŠŸ
        if (compareAndSetState(0, acquires)) {
        	// è®¾ç½®å½“å‰çº¿ç¨‹ï¼ˆçº¿ç¨‹Bï¼‰ä¸ºæ‹¥æœ‰é”çš„çº¿ç¨‹
            setExclusiveOwnerThread(current);
            // è¿”å›true
            return true;
        }
    }
    else if (current == getExclusiveOwnerThread()) {
        int nextc = c + acquires;
        if (nextc < 0) // overflow
            throw new Error("Maximum lock count exceeded");
        setState(nextc);
        return true;
    }
    return false;
}
```
æ­¤æ—¶`tryAcquire(arg)`æ–¹æ³•è¿”å›trueï¼Œå†å›åˆ°ã€æ ‡è®°15ã€‘

```java
for (;;) {
	// è·å¾—nodeèŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯å¤´ç»“ç‚¹
    final Node p = node.predecessor();
    // ifæ¡ä»¶æˆç«‹
    if (p == head && tryAcquire(arg)) {
    	// å°†å½“å‰èŠ‚ç‚¹è®¾ç½®ä¸ºå¤´ç»“ç‚¹
        setHead(node);
        // å°†åŸæ¥çš„å¤´ç»“ç‚¹çš„nextæŒ‡é’ˆæŒ‡å‘nullï¼Œåƒåœ¾å›æ”¶çš„æ—¶å€™ä¼šå›æ”¶æ‰åŸæ¥å¤´ç»“ç‚¹
        p.next = null; // help GC
        failed = false;
        // è¿”å›false
        return interrupted;
    }
    // å› ä¸ºparkAndCheckInterrupt()è¿”å›falseï¼Œæ‰€ä»¥è¿™é‡Œçš„ifæ¡ä»¶ä¸æˆç«‹
    if (shouldParkAfterFailedAcquire(p, node) &&
        parkAndCheckInterrupt())
        interrupted = true;
}
```
è‡³æ­¤ã€æ ‡è®°7ã€‘å¤„çš„`acquireQueued`æ–¹æ³•æ‰§è¡Œå®Œæ¯•ï¼Œè¿”å›falseã€‚

å†å›åˆ°ã€æ ‡è®°4ã€‘
```java
public final void acquire(int arg) {
	// å‰é¢è®¨è®ºè¿‡ !tryAcquire(arg) = true
	// åˆšåˆšè®¨è®ºå‡ºacquireQueued() è¿”å›false
	// ifæ¡ä»¶ä¸æˆç«‹
    if (!tryAcquire(arg) && acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
        selfInterrupt();
}
```
`acquire`æ–¹æ³•æ‰§è¡Œå®Œæ¯•ï¼Œå›åˆ°ã€æ ‡è®°3ã€‘`NonfairSync`ä¸­çš„`lock()`æ–¹æ³•ï¼Œæ­¤æ—¶lock()è¿è¡Œå®Œæ¯•

```java
final void lock() {
    if (compareAndSetState(0, 1))
        setExclusiveOwnerThread(Thread.currentThread());
    else
        acquire(1);
}
```

å›åˆ°ã€æ ‡è®°2ã€‘ï¼Œçº¿ç¨‹è·å–é”æˆåŠŸï¼Œå¼€å§‹å·¥ä½œã€‚

```java
// çº¿ç¨‹B
new Thread(() -> {
    lock.lock();
    System.out.println(Thread.currentThread().getName() + "\t" + "å¼€å§‹å·¥ä½œï¼");
    try {  Thread.sleep(2000); } catch (InterruptedException e) { e.printStackTrace(); }
    lock.unlock();
}, "A").start();
```

è‡³æ­¤ï¼Œæˆ‘ä»¬åˆ†æå®Œäº†çº¿ç¨‹ç©ºé—²çŠ¶æ€è·å–é”ã€é‡Šæ”¾é”ã€é˜»å¡çŠ¶æ€è·å–é”çš„å…¨è¿‡ç¨‹ã€‚
