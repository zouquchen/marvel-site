---
title: Springä¸‰çº§ç¼“å­˜è§£å†³å¾ªç¯ä¾èµ–
date: 2024-03-25 14:44:07
permalink: /pages/93a802/
categories:
  - æ¡†æ¶
  - Spring
tags:
  - Spring
  - æºç 
  - æ¡†æ¶
author: 
  name: Marvel
  link: https://github.com/zouquchen
---
::: note é—®é¢˜
- ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ–ï¼Ÿ
- Spring å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–ï¼Ÿ
- ä»€ä¹ˆæ˜¯ä¸‰çº§ç¼“å­˜ï¼Ÿ
- å¦‚ä½•ç”¨äºŒçº§ç¼“å­˜è§£å†³å¾ªç¯ä¾èµ–ï¼Ÿ
- å¦‚ä½•ç”¨ä¸‰çº§ç¼“å­˜è§£å†³å¾ªç¯ä¾èµ–ï¼Ÿ
- ä¸‰çº§ç¼“å­˜è§£å†³å¾ªç¯ä¾èµ–çš„æºç ï¼Ÿ
  :::
  <!-- more -->

# Spring å¾ªç¯ä¾èµ–è§£å†³ä¸‰çº§ç¼“å­˜
## 1. å¾ªç¯ä¾èµ–

ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ–ï¼Ÿ

```java
// A ä¾èµ–äº B
public class A {
	@Autowird
	private B b;
}
// B ä¾èµ–äº A
public class B {
	@Autowird
	private A a;
}
```

<img src="https://raw.githubusercontent.com/zouquchen/Images/main/imgs2022/beans-dependency.png" alt="beans-dependency" style="zoom:50%;" />

[å¾ªç¯ä¾èµ–å®˜æ–¹è§£é‡Š](https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-dependency-resolution)ï¼š

> Circular dependencies
>
> If you use predominantly constructor injection, it is possible to create an unresolvable circular dependency scenario.
>
> For example: Class A requires an instance of class B through constructor injection, and class B requires an instance of class A through constructor injection. If you configure beans for classes A and B to be injected into each other, the Spring IoC container detects this circular reference at runtime, and throws a `BeanCurrentlyInCreationException`.
>
> One possible solution is to edit the source code of some classes to be configured by setters rather than constructors. Alternatively, avoid constructor injection and use setter injection only. In other words, although it is not recommended, you can configure circular dependencies with setter injection.
>
> Unlike the typical case (with no circular dependencies), a circular dependency between bean A and bean B forces one of the beans to be injected into the other prior to being fully initialized itself (a classic chicken-and-egg scenario).

ä¾èµ–çš„æ³¨å…¥æ–¹å¼

- æ„é€ æ–¹æ³•æ³¨å…¥ï¼ˆæ— æ³•è§£å†³å¾ªç¯ä¾èµ–ï¼‰
- Setæ³¨å…¥ï¼ˆèƒ½å¤Ÿè§£å†³å¾ªç¯ä¾èµ–ï¼‰

é»˜è®¤çš„å•ä¾‹ï¼ˆsingletonï¼‰çš„åœºæ™¯æ”¯æŒå¾ªç¯ä¾èµ–ï¼›åŸå‹ï¼ˆPrototypeï¼‰çš„åœºæ™¯ä¸æ”¯æŒå¾ªç¯ä¾èµ–ï¼Œä¼šæŠ¥é”™ã€‚

## 2. å‰ç½®çŸ¥è¯†

> æš‚æ—¶å…ˆç®€å•æè¿°ä¸€ä¸‹ï¼Œä¹‹åå†å¥½å¥½ç ”ç©¶å¹¶å®Œå–„ã€‚

éœ€è¦äº†è§£ Bean çš„åˆ›å»ºæµç¨‹ï¼š

1. æ¨æ–­é€‰æ‹©æ„é€ å™¨
2. å®ä¾‹åŒ–å¯¹è±¡
3. å¡«å……å±æ€§ï¼Œä¹Ÿå°±æ˜¯ä¾èµ–æ³¨å…¥
4. åˆå§‹åŒ–å‰ï¼ˆå¦‚ï¼Œæ‰§è¡Œå¸¦æœ‰ @PostConstruct æ³¨è§£çš„æ–¹æ³•ï¼‰
5. åˆå§‹åŒ–ï¼ˆå¦‚ï¼Œå¤„ç† InitializingBean æ¥å£ï¼‰
6. åˆå§‹åŒ–åï¼ˆAOP å¢å¼ºï¼‰
7. ä»£ç†å¯¹è±¡æ”¾å…¥å•ä¾‹æ± 

éœ€è¦åŒºåˆ†å®ä¾‹åŒ–å’Œåˆå§‹åŒ–çš„åŒºåˆ«ï¼š

- å®ä¾‹åŒ–ï¼šé€šè¿‡æ„é€ å™¨å¾—åˆ°ä¸€ä¸ªå¯¹è±¡ï¼Œé‡Œé¢çš„å±æ€§å€¼ä¸º null

- åˆå§‹åŒ–ï¼šå¯¹å·²ç»å®ä¾‹åŒ–çš„å¯¹è±¡ï¼Œæ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•ï¼ˆè‡ªå®šä¹‰çš„æ–¹æ³•ï¼‰

## 3. ä¸‰çº§ç¼“å­˜è§£å†³å¾ªç¯ä¾èµ–

### 3.1 ä¸‰çº§ç¼“å­˜

```java
public class DefaultSingletonBeanRegistry extends SimpleAliasRegistry implements SingletonBeanRegistry { 
    /** Cache of singleton objects: bean name to bean instance. */
    private final Map<String, Object> singletonObjects = new ConcurrentHashMap<>(256); // ä¸€çº§ç¼“å­˜ï¼Œå•ä¾‹æ± 

    /** Cache of singleton factories: bean name to ObjectFactory. */
    private final Map<String, ObjectFactory<?>> singletonFactories = new HashMap<>(16); // ä¸‰çº§ç¼“å­˜

    /** Cache of early singleton objects: bean name to bean instance. */
    private final Map<String, Object> earlySingletonObjects = new HashMap<>(16);  // äºŒçº§ç¼“å­˜
    
    ...
}
```

â­ **ç¬¬ä¸€çº§ç¼“å­˜**ï¼šsingletonObjectsï¼Œ**å­˜æ”¾å®Œæˆå“å¯¹è±¡**

å•ä¾‹æ± ï¼Œå­˜æ”¾å·²ç»ç»å†äº†å®Œæ•´ç”Ÿå‘½å‘¨æœŸçš„ Beanå¯¹è±¡

â­ **ç¬¬äºŒçº§ç¼“å­˜**ï¼šearlySingletonObjectsï¼Œ**å­˜æ”¾åŠæˆå“å¯¹è±¡**

æ—©æœŸå•ä¾‹å¯¹è±¡çš„é«˜é€Ÿç¼“å­˜ï¼Œè¡¨ç¤º Bean çš„ç”Ÿå‘½å‘¨æœŸè¿˜æ²¡èµ°å®Œï¼ˆBean çš„å±æ€§è¿˜æœªå¡«å……ï¼‰å°±æŠŠè¿™ ä¸ªBean å­˜å…¥è¯¥ç¼“å­˜ä¸­ï¼Œä¹Ÿå°±æ˜¯å®ä¾‹åŒ–ä½†æœªåˆå§‹åŒ–çš„ Bean æ”¾å…¥è¯¥ç¼“å­˜é‡Œã€‚åŒæ—¶ä¹Ÿä¿è¯äº†å•ä¾‹ï¼Œä¸ä¼šé‡å¤åˆ›å»ºã€‚

â­ **ç¬¬ä¸‰çº§ç¼“å­˜**ï¼šMap<String, ObjectFactory<?>> singletonFactoriesï¼Œ**å­˜æ”¾ lambda è¡¨è¾¾å¼**

å•ä¾‹å·¥å‚çš„é«˜é€Ÿç¼“å­˜ï¼Œå­˜æ”¾å¯ä»¥ç”Ÿæˆ Bean çš„å·¥å‚ã€‚å‡å¦‚ A ç±»å®ç°äº†FactoryBeanï¼Œé‚£ä¹ˆä¾èµ–æ³¨å…¥çš„æ—¶å€™ä¸æ˜¯ A ç±»ï¼Œè€Œæ˜¯ A ç±»äº§ç”Ÿçš„ Beanã€‚

### 3.2 äºŒçº§ç¼“å­˜è§£å†³å¾ªç¯ä¾èµ–

åªä½¿ç”¨ä¸¤çº§ç¼“å­˜èƒ½å¦è§£å†³å¾ªç¯ä¾èµ–å‘¢ï¼Ÿå…¶å®æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯è¦ä¿è¯å¯¹è±¡æ²¡æœ‰ç»è¿‡ AOP å¢å¼ºï¼Œä¸‹é¢æ¥è¯´è¯´åŸç†ã€‚

æˆ‘ä»¬æ¥é‡æ–°çœ‹ä¸€ä¸‹å¾ªç¯ä¾èµ–çš„é—®é¢˜ï¼š

![1.å¾ªç¯ä¾èµ–](https://raw.githubusercontent.com/zouquchen/Images/main/imgs2022/circle-dependeny1.png)

æ­¥éª¤å¦‚ä¸‹ï¼š

1. åˆ›å»º A å¯¹è±¡
2. å®ä¾‹åŒ– A å¯¹è±¡ï¼Œæ­¤æ—¶ b=null
3. ç»™ A å¯¹è±¡çš„ b å±æ€§èµ‹å€¼ï¼Œä¹Ÿå°±æ˜¯ä¾èµ–æ³¨å…¥
4. åˆ¤æ–­ B å¯¹è±¡æ˜¯å¦å­˜åœ¨ï¼Œæ­¤æ—¶ B å¯¹è±¡ä¸å­˜åœ¨
5. åˆ›å»º B å¯¹è±¡
6. å®ä¾‹åŒ– B å¯¹è±¡ï¼Œæ­¤æ—¶ a=null
7. ç»™ B å¯¹è±¡çš„ a å±æ€§èµ‹å€¼ï¼Œä¹Ÿå°±æ˜¯ä¾èµ–æ³¨å…¥
8. åˆ¤æ–­ A å¯¹è±¡æ˜¯å¦å­˜åœ¨ï¼Œæ­¤æ—¶ B å¯¹è±¡ä¸å­˜åœ¨
9. é‡å¤æ­¥éª¤ 1 - 9

æƒ³è¦æ‰“ç ´å¾ªç¯ä¾èµ–é—®é¢˜ï¼Œå¯ä»¥åœ¨æ­¥éª¤ 9 çš„åœ°æ–¹æ‰“ç ´å¾ªç¯ã€‚

æ­¤æ—¶å¯ä»¥å¼•å…¥ä¸¤ä¸ªç¼“å­˜ï¼ˆMapï¼‰ï¼Œä¸€çº§ç¼“å­˜ singletonObjects å­˜å‚¨å®Œæ•´å¯¹è±¡ï¼ŒäºŒçº§ç¼“å­˜ earlySingletonObjects å­˜å‚¨åŠæˆå“å¯¹è±¡ã€‚

![2.æ‰“ç ´å¾ªç¯ä¾èµ–](https://raw.githubusercontent.com/zouquchen/Images/main/imgs2022/circle-dependency2.png)

æ­¥éª¤å¦‚ä¸‹ï¼š

1. åˆ›å»º A å¯¹è±¡
2. å®ä¾‹åŒ– A å¯¹è±¡ï¼Œæ­¤æ—¶ b=null
3. å°†åŠæˆå“ A å¯¹è±¡æ”¾å…¥äºŒçº§ç¼“å­˜
4. ç»™ A å¯¹è±¡çš„ b å±æ€§èµ‹å€¼
5. åˆ¤æ–­ä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜ä¸­æ˜¯å¦æœ‰ B å¯¹è±¡ï¼Œæ­¤æ—¶æ²¡æœ‰
6. åˆ›å»º B å¯¹è±¡
7. å®ä¾‹åŒ– B å¯¹è±¡ï¼Œæ­¤æ—¶ a=null
8. å°†åŠæˆå“ B å¯¹è±¡æ”¾å…¥äºŒçº§ç¼“å­˜
9. ç»™ B å¯¹è±¡çš„ a å±æ€§èµ‹å€¼
10. åˆ¤æ–­ä¸€çº§ç¼“å­˜ä¸­æ˜¯å¦æœ‰ A å¯¹è±¡ï¼Œæ²¡æœ‰
11. åˆ¤æ–­äºŒçº§ç¼“å­˜ä¸­æ˜¯å¦æœ‰ A å¯¹è±¡ï¼Œæœ‰
12. å°†äºŒçº§ç¼“å­˜ä¸­çš„ A å¯¹è±¡èµ‹å€¼ç»™ B å¯¹è±¡çš„ a å±æ€§
13. æ­¤æ—¶ B å¯¹è±¡å®Œæˆäº†åˆ›å»ºï¼Œå°†å…¶ä»äºŒçº§ç¼“å­˜ç§»åˆ°ä¸€çº§ç¼“å­˜
14. å›åˆ°æ­¥éª¤ 4ï¼Œç»™ A å¯¹è±¡çš„ b å±æ€§èµ‹å€¼
15. åˆ¤æ–­ä¸€çº§ç¼“å­˜ä¸­æ˜¯å¦æœ‰ B å¯¹è±¡ï¼Œæœ‰
16. å°†ä¸€çº§ç¼“å­˜ä¸­çš„ B å¯¹è±¡èµ‹å€¼ç»™ A å¯¹è±¡çš„ b å±æ€§
17. æ­¤æ—¶ A å¯¹è±¡å®Œæˆäº†åˆ›å»ºï¼Œå°†å…¶ä»äºŒçº§ç¼“å­˜ç§»åˆ°ä¸€çº§ç¼“å­˜

è¿™é‡Œä¸ºä»€ä¹ˆè¦ä½¿ç”¨ä¸¤ä¸ªç¼“å­˜å‘¢ï¼Œå› ä¸ºè¦ä¿è¯åªæœ‰ç»å†äº†å®Œæ•´ç”Ÿå‘½å‘¨æœŸçš„ Bean å¯¹è±¡æ‰æ”¾å…¥å•ä¾‹æ± ï¼ˆä¸€çº§ç¼“å­˜ï¼‰ä¸­ï¼Œå¦‚æœåŠæˆå“å¯¹è±¡ä¹Ÿæ”¾å…¥å•ä¾‹æ± ä¸­ï¼Œå¯èƒ½ä¼šä»å•ä¾‹æ± ä¸­å–å‡ºåŠæˆå“çš„ Bean å¯¹è±¡å¯¼è‡´å‡ºé”™ã€‚æ‰€ä»¥ï¼Œæˆå“å¯¹è±¡å’ŒåŠæˆå“å¯¹è±¡åˆ†å¼€æ”¾ã€‚

### 3.3 ä¸‰çº§ç¼“å­˜è§£å†³å¾ªç¯ä¾èµ–

å‡è®¾ï¼ŒA å’Œ B éƒ½è¿›è¡Œäº† AOPï¼Œæ­¤æ—¶åœ¨è¿›è¡Œä¸Šé¢çš„æ­¥éª¤ï¼š

![äºŒçº§ç¼“å­˜è§£å†³å¾ªç¯ä¾èµ–AOPé—®é¢˜](https://raw.githubusercontent.com/zouquchen/Images/main/imgs2022/circle-dependency4.png)

ç»è¿‡ä¸Šé¢çš„æ“ä½œåï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼š

- ä»£ç† A å¯¹è±¡ä¸­åŒ…å«ä»£ç† B å¯¹è±¡ï¼Œæ­£ç¡®
- ä»£ç† B å¯¹è±¡ä¸­åŒ…å«æ™®é€š A å¯¹è±¡ï¼Œé”™è¯¯ï¼Œä¹Ÿå°±æ˜¯è¯´ B å¯¹è±¡ä¸­æ²¡æœ‰å°†æœ€ç»ˆçš„ä»£ç† A å¯¹è±¡æ³¨å…¥è¿›å»ï¼Œè€Œæ˜¯åœ¨ä¹‹å‰æ³¨å…¥äº†ä¸€ä¸ªæ™®é€šå¯¹è±¡ã€‚

å‡ºç°è¿™ä¸ªé—®é¢˜çš„åŸå› æ˜¯ï¼šå½“å¾ªç¯ä¾èµ–å‡ºç°æ—¶ï¼Œæœªç»å† AOP çš„å¯¹è±¡å°±è¢«æ³¨å…¥åˆ°äº†å…¶ä»– Bean å¯¹è±¡ä¸­ã€‚

è§£å†³æ–¹æ¡ˆï¼š**å½“å¾ªç¯ä¾èµ–å‡ºç°æ—¶ï¼Œå°†è¢«æ³¨å…¥çš„å¯¹è±¡æå‰è¿›è¡Œ AOP å¢å¼º**

![4.ä¸‰çº§ç¼“å­˜è§£å†³å¾ªç¯ä¾èµ–AOPé—®é¢˜](https://raw.githubusercontent.com/zouquchen/Images/main/imgs2022/circle-dependency5.png)

Spring ä¸çŸ¥é“åœ¨åˆ›å»º Bean çš„è¿‡ç¨‹ä¸­ï¼Œæ˜¯å¦ä¼šå‡ºç°å¾ªç¯ä¾èµ–ï¼Œæ˜¯å¦ä¼šè¿›è¡Œ AOPï¼Œæ‰€ä»¥å°†åˆ›å»º Bean çš„è¿‡ç¨‹å†™æˆä¸€ä¸ª lambda è¡¨è¾¾å¼æ”¾å…¥ä¸‰çº§ç¼“å­˜å½“ä¸­ã€‚å½“éœ€è¦çš„æ—¶å€™å¯ä»¥é€šè¿‡è¿™ä¸ª lambda è¡¨è¾¾å¼åˆ›å»ºå¯¹è±¡ã€‚

**è¯¦ç»†æµç¨‹**

1. å¼€å§‹åˆ›å»º A å¯¹è±¡
2. å®ä¾‹åŒ– A å¯¹è±¡
3. å°† lambda è¡¨è¾¾å¼å†™å…¥ä¸‰çº§ç¼“å­˜ä¸­
4. ä¸º A å¯¹è±¡å¡«å……å±æ€§
5. æ‰«æå‘ç° A å¯¹è±¡ä¾èµ– B å¯¹è±¡ï¼Œæ­¤æ—¶å®¹å™¨ä¸­æ²¡æœ‰ B å¯¹è±¡
6. å¼€å§‹åˆ›å»º B å¯¹è±¡
7. å®ä¾‹åŒ– B å¯¹è±¡
8. å°† lambda è¡¨è¾¾å¼å†™å…¥ä¸‰çº§ç¼“å­˜ä¸­
9. ä¸º B å¯¹è±¡å¡«å……å±æ€§
10. æ‰«æå‘ç° B å¯¹è±¡ä¾èµ– A å¯¹è±¡ï¼Œåˆ¤æ–­å®¹å™¨ä¸­æ˜¯å¦æœ‰ A å¯¹è±¡
11. åˆ†åˆ«åˆ¤æ–­ä¸€çº§ã€äºŒçº§ã€ä¸‰çº§ç¼“å­˜ä¸­æ˜¯å¦æœ‰ A å¯¹è±¡ï¼Œåœ¨ä¸‰çº§ç¼“å­˜ä¸­æœ‰ A çš„ lambda è¡¨è¾¾å¼
12. æ‰§è¡Œ lambda è¡¨è¾¾å¼ï¼Œå¦‚æœæœ‰ AOP å¢å¼ºå°±è¿”å› A çš„ä»£ç†å¯¹è±¡ï¼Œå¦åˆ™å°±è¿”å› A çš„åŸå§‹å¯¹è±¡
13. å°† A ä»ä¸‰çº§ç¼“å­˜ç§»åŠ¨åˆ°äºŒçº§ç¼“å­˜
14. ç»™ B å¯¹è±¡ä¸­çš„ a å±æ€§è¿›è¡Œèµ‹å€¼ï¼ŒæŠŠ A å¯¹è±¡æ³¨å…¥è¿›å»ï¼Œæ­¤æ—¶ B å·²ç»å®Œæˆäº†åˆ›å»º
15. å°† B å¯¹è±¡æ”¾åˆ°ä¸€çº§ç¼“å­˜ï¼Œåˆ é™¤äºŒçº§å’Œä¸‰çº§ç¼“å­˜ä¸­çš„ B å¯¹è±¡ã€‚
16. ç»™ A å¯¹è±¡ä¸­çš„ b  å±æ€§è¿›è¡Œèµ‹å€¼ï¼ŒæŠŠ B å¯¹è±¡æ³¨å…¥è¿›å»ï¼Œæ­¤æ—¶ A å·²ç»å®Œæˆäº†åˆ›å»º
17. å°† A å¯¹è±¡æ”¾åˆ°ä¸€çº§ç¼“å­˜ï¼Œåˆ é™¤äºŒçº§å’Œä¸‰çº§ç¼“å†²ä¸­çš„ A å¯¹è±¡ã€‚

![ä¸‰çº§ç¼“å­˜è§£å†³å¾ªç¯ä¾èµ–](https://raw.githubusercontent.com/zouquchen/Images/main/imgs2022/3-map-bean-dependency.png)

**ç®€å•è¿‡ç¨‹**

1. A åˆ›å»ºè¿‡ç¨‹éœ€è¦ Bï¼Œäºæ˜¯Aå°†è‡ªå·±æ”¾åˆ°ä¸‰çº§ç¼“å­˜é‡Œé¢ï¼Œå»å®ä¾‹åŒ– B

2. B å®ä¾‹åŒ–çš„æ—¶å€™å‘ç°éœ€è¦ Aï¼Œäºæ˜¯ B å…ˆæŸ¥ä¸€çº§ç¼“å­˜ï¼Œæ²¡æœ‰ï¼Œå†æŸ¥äºŒçº§ç¼“å­˜ï¼Œæ²¡æœ‰ï¼Œå†æŸ¥ä¸‰çº§ç¼“å­˜ï¼Œæ‰¾åˆ°äº† Aï¼ˆæ‰§è¡Œ Lamda è¡¨è¾¾å¼ï¼‰ï¼Œç„¶åæŠŠä¸‰çº§ç¼“å­˜é‡Œé¢çš„ A ç§»åŠ¨äºŒçº§ç¼“å­˜é‡Œã€‚
3. B åˆå§‹åŒ–å®Œæ¯•ï¼Œå°†è‡ªå·±æ”¾åˆ°ä¸€çº§ç¼“å­˜ï¼ˆæ­¤æ—¶ B é‡Œé¢çš„ A ä¾ç„¶æ˜¯åˆ›å»ºä¸­çŠ¶æ€ï¼‰ã€‚
4. ç»§ç»­åˆ›å»º Aï¼Œæ­¤æ—¶ B å·²ç»åˆ›å»ºç»“æŸï¼Œç›´æ¥ä»ä¸€çº§ç¼“å­˜é‡Œé¢æ‹¿åˆ° Bï¼Œå®Œæˆåˆ›å»ºï¼Œå¹¶å°† A æ”¾åˆ°ä¸€çº§ç¼“å­˜ä¸­ã€‚

## 4. æºç æµ‹è¯•

### 4.1 ç¯å¢ƒæ­å»º

é…ç½® Spring çš„ç¯å¢ƒï¼Œåˆ›å»ºä»¥ä¸‹å†…å®¹ï¼š

A ç±»é‡Œé¢åŒ…å« B ç±»

```java
public class A {
    private B b;

    public B getB() {
        return b;
    }

    public void setB(B b) {
        this.b = b;
    }
}
```

B ç±»é‡Œé¢åŒ…å« A ç±»

```java
public class B {
    private A a;

    public A getA() {
        return a;
    }

    public void setA(A a) {
        this.a = a;
    }
}
```

æ³¨è§£é…ç½®ï¼Œåˆ›å»º a å’Œ b ä¸¤ä¸ª bean å¯¹è±¡ï¼Œå¹¶ä¸ºä»–ä»¬æ³¨å…¥å±æ€§ã€‚

```xml
<bean class="com.zqc.domain.A" id="a">
    <property name="b" ref="b"/>
</bean>
<bean class="com.zqc.domain.B" id="b">
    <property name="a" ref="a" />
</bean>
```

å¯åŠ¨ç±»ï¼Œé€šè¿‡æ³¨è§£åˆ›å»º Spring å®¹å™¨ã€‚

```java
public class SpringDemo {
    public static void main(String[] args) {
        ApplicationContext context = new ClassPathXmlApplicationContext("applicationContext.xml");
        A bean = context.getBean(A.class);
        System.out.println(bean);
    }
}
```

### 4.2 æºç 

Debugï¼šåˆ›å»ºè¿‡ç¨‹çš„å…³é”®æ–¹æ³•ï¼šgetBeanã€doGetBeanã€getSingletonã€createBeanã€doCreateBeanã€createBeanInstanceã€populateBeanã€addSingleton



ä» Spring åˆ›å»ºå®¹å™¨å¼€å§‹ï¼š

```java
ApplicationContext context = new ClassPathXmlApplicationContext("applicationContext.xml");
```

```java
public ClassPathXmlApplicationContext(
    String[] configLocations, boolean refresh, @Nullable ApplicationContext parent)
    throws BeansException {

    super(parent);
    setConfigLocations(configLocations);
    if (refresh) {
        refresh();
    }
}
```

æ‰¾åˆ°å…¶ä¸­çš„ refresh() æ–¹æ³•ï¼Œrefresh() æ˜¯åˆ›å»ºå®¹å™¨çš„æ ¸å¿ƒæ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­æ‰¾åˆ° `finishBeanFactoryInitialization(beanFactory)`ï¼Œè¯¥æ–¹æ³•ç”¨æ¥å®ä¾‹åŒ–æ‰€æœ‰éæ‡’åŠ è½½çš„å•ä¾‹ã€‚åœ¨è¯¥æ–¹æ³•ä¸­çš„æœ€åä¸€è¡Œæ‰¾åˆ° `beanFactory.preInstantiateSingletons()`ï¼ŒçœŸæ­£ç”¨æ¥å®ç°æ‰€æœ‰éæ‡’åŠ è½½çš„å•ä¾‹ã€‚

```java
public void preInstantiateSingletons() throws BeansException {
		...
        // è·å–éœ€è¦å®ä¾‹åŒ–çš„ bean çš„åç§°
		List<String> beanNames = new ArrayList<>(this.beanDefinitionNames);

		// Trigger initialization of all non-lazy singleton beans...
		for (String beanName : beanNames) { // éå†åˆ›å»º
			RootBeanDefinition bd = getMergedLocalBeanDefinition(beanName);
			if (!bd.isAbstract() && bd.isSingleton() && !bd.isLazyInit()) {
				if (isFactoryBean(beanName)) { // if ä¸æˆç«‹
					...
				}
				else {
                    // æ‰§è¡Œåˆ°è¿™é‡Œ
					getBean(beanName);
				}
			}
		}
		...
}
		
```

ç¬¬ä¸€æ¬¡è¿è¡Œåˆ°è¿™æ®µä»£ç çš„æ—¶å€™ï¼ŒbeanNames åŒ…å« a å’Œ b ä¸¤ä¸ªå­—ç¬¦ä¸²ï¼Œä¹Ÿå°±æ˜¯è¯´ä¼šé€šè¿‡è¿™ä¸ªæ–¹æ³•åˆ›å»º A å’Œ B çš„ beanå¯¹è±¡ã€‚è¯¥æ–¹æ³•æœ€ç»ˆè°ƒç”¨åˆ°äº† `getBean(beanName)` æ–¹æ³•ã€‚

<img src="https://raw.githubusercontent.com/zouquchen/Images/main/imgs2022/preInstantiateSingletons.png" alt="image-20220830104313440" style="zoom:67%;" />

ä¸‹é¢å†ç»§ç»­çœ‹ `getBean()` æ–¹æ³•

```java
public Object getBean(String name) throws BeansException {
    return doGetBean(name, null, null, false);
}
```

`getBean()` æ–¹æ³•ä¼šè°ƒç”¨ `doGetBean()` æ–¹æ³•æ¥å®Œæˆç›¸å…³åŠŸèƒ½å—ï¼ŒdoGetBean() æ–¹æ³•è¿˜æ˜¯æŒºå¤šçš„ï¼Œæˆ‘ä»¬åªçœ‹å…¶ä¸­ä¸€éƒ¨åˆ†ã€‚

```java
protected <T> T doGetBean(final String name, @Nullable final Class<T> requiredType,
			@Nullable final Object[] args, boolean typeCheckOnly) throws BeansException {

    final String beanName = transformedBeanName(name);
    Object bean;

    // Eagerly check singleton cache for manually registered singletons.
    // å…ˆçœ‹çœ‹è¿™ä¸ª bean æœ‰æ²¡æœ‰
    Object sharedInstance = getSingleton(beanName);
    
    if (sharedInstance != null && args == null) {
        ...
    }

    else {
        ...

        try {
            ...
            // Create bean instance.
            if (mbd.isSingleton()) {
                sharedInstance = getSingleton(beanName, () -> {
                    try {
                        return createBean(beanName, mbd, args);
                    }
                    catch (BeansException ex) {
                        ...
                    }
                });
                bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);
            }
            ...
        }
        catch (BeansException ex) {
            ...
        }
    }
	...
    return (T) bean;
}
```

åœ¨ `doGetBean()` æ–¹æ³•ä¸­ï¼Œé¦–å…ˆä¼šå°è¯•ä½¿ç”¨ `getSingleton()` æ–¹æ³•æ¥è·å– bean å¯¹è±¡ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹èƒ½å¦è·å–åˆ°ï¼š

```java
// beanName ä¸º "a"
public Object getSingleton(String beanName) {
    return getSingleton(beanName, true);  // è°ƒç”¨é‡è½½æ–¹æ³•ï¼Œæ‰§è¡Œä¸‹é¢çš„æ–¹æ³•
}

protected Object getSingleton(String beanName, boolean allowEarlyReference) {
    Object singletonObject = this.singletonObjects.get(beanName);  // ä»å•ä¾‹æ± ä¸­è·å–ï¼Œnull
    
    // singletonObject == null æˆç«‹ true
    // isSingletonCurrentlyInCreation("a") å•ä¾‹ a å½“å‰æ­£åœ¨åˆ›å»º ä¸æˆç«‹ false
    if (singletonObject == null && isSingletonCurrentlyInCreation(beanName)) {  
        ...
    }
    return singletonObject; // æ‰€ä»¥ç›´æ¥è¿”å› null
}
```

æ‰€ä»¥ `Object sharedInstance = getSingleton(beanName)`åï¼ŒsharedInstance ä¸º nullã€‚æœ€ç»ˆä¼šæ¥åˆ° doGetBean ä¸­çš„è¿™æ®µä»£ç ï¼š

```java
// Create bean instance.
if (mbd.isSingleton()) {
    sharedInstance = getSingleton(beanName, () -> {
        try {
            return createBean(beanName, mbd, args);
        }
        catch (BeansException ex) {
            ...
        }
    });
    ...
}
```

åŒæ ·é€šè¿‡ `getSingleton(String beanName, ObjectFactory<?> singletonFactory)` æ–¹æ³•æ¥è·å–å•ä¾‹å¯¹è±¡ï¼Œä½†æ˜¯ç¬¬äºŒä¸ªå‚æ•°ä¼ è¿›å»äº†ä¸€ä¸ª lambda è¡¨è¾¾å¼ï¼Œè¿™ä¸ª lambda è¡¨è¾¾å¼ç”¨äºåˆ›å»º bean å¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœ getSingleton æ— æ³•è·å–åˆ°å¯¹è±¡çš„æ—¶å€™ä¼šé€šè¿‡è¿™ä¸ª lambda è¡¨è¾¾å¼ä¸­çš„ createBean æ–¹æ³•æ¥åˆ›å»ºå¯¹è±¡ã€‚

> ObjectFactory æ˜¯å‡½æ•°å¼æ¥å£ï¼Œæœ‰ä¸”ä»…æœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œå¯ä»¥å½“ä½œæ–¹æ³•çš„å‚æ•°ä¼ é€’è¿›å»ï¼Œå½“æŒ‡æ˜æ­¤ç±»å‹å‚æ•°çš„æ–¹æ³•ï¼Œå¯ä»¥ä¼ å…¥ä¸€ä¸ª lambda è¡¨è¾¾å¼ï¼Œåœ¨æ‰§è¡Œæ­¤è¡Œä»£ç çš„æ—¶å€™å¹¶ä¸ä¼šæ‰§è¡Œ lambda è¡¨è¾¾å¼ï¼Œè€Œæ˜¯åœ¨è°ƒç”¨ getObject æ–¹æ³•æ—¶æ‰ä¼šæ‰§è¡Œ lambda è¡¨è¾¾å¼çš„å¤„ç†é€»è¾‘ã€‚

ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ª `getSingleton()` å¦‚ä½•è°ƒç”¨è¿™ä¸ª lambda è¡¨è¾¾å¼åˆ›å»ºå¯¹è±¡çš„ã€‚

```java
public Object getSingleton(String beanName, ObjectFactory<?> singletonFactory) {
    ...
    synchronized (this.singletonObjects) {
        Object singletonObject = this.singletonObjects.get(beanName); // ä»å•ä¾‹æ± ä¸­è·å– bean å¯¹è±¡ï¼Œå¾—ä¸åˆ°ï¼Œè¿”å› null
        if (singletonObject == null) { // if æˆç«‹
            ...
            try {
                singletonObject = singletonFactory.getObject();  // æ‰§è¡Œ getObject()ï¼Œå°±åˆå›åˆ°äº† lambda è¡¨è¾¾å¼
                
                // lambda è¡¨è¾¾å¼æ‰§è¡Œå®Œæ¯•åè¦å›åˆ°è¿™é‡Œç»§ç»­è¿è¡Œ
                newSingleton = true;
            }
            ...
            if (newSingleton) {
                addSingleton(beanName, singletonObject);
            }
        }
        return singletonObject;
    }
}
```

é€šè¿‡ `singletonObject = singletonFactory.getObject()` è¯­å¥è¿è¡Œäº† lambda è¡¨è¾¾å¼ï¼Œä¸è¿‡è¦è®°å¾— lambda è¡¨è¾¾å¼è¿è¡Œå®Œæ¯•åå›åˆ°è¿™é‡Œï¼Œåœ¨è¿™é‡Œæ’ä¸ªæ——å¸œã€ğŸš©æ ‡è®°1ã€‘ã€‚

ä¸‹é¢æˆ‘ä»¬å†çœ‹çœ‹è¿™ä¸ª lambda è¡¨è¾¾å¼ã€‚

```java
sharedInstance = getSingleton(beanName, () -> {
    try {
        return createBean(beanName, mbd, args);
    }
    catch (BeansException ex) {
        ...
    }
});
```

å…¶å®å°±æ˜¯æ‰§è¡Œäº† `createBean(beanName, mbd, args)` æ–¹æ³•ã€‚

```java
protected Object createBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args)
    ...
    try {
        Object beanInstance = doCreateBean(beanName, mbdToUse, args); // ä½¿ç”¨ doCreateBean åˆ›å»º Bean å¯¹è±¡
        ...
        return beanInstance;
    }
    ...
}
```

`createBean()` æ–¹æ³•åˆè°ƒç”¨ `doCreateBean()` æ–¹æ³•ï¼Œç»ˆäºåˆ°é‡ç‚¹éƒ¨åˆ†äº†ï¼Œå¼€å§‹åˆ›å»º bean å¯¹è±¡ã€‚

```java
protected Object doCreateBean(final String beanName, final RootBeanDefinition mbd, final @Nullable Object[] args)
			throws BeanCreationException {

    // Instantiate the bean.
    BeanWrapper instanceWrapper = null;
    ...
    // é€šè¿‡åå°„åˆ›å»º bean çš„å®ä¾‹
    if (instanceWrapper == null) {
        instanceWrapper = createBeanInstance(beanName, mbd, args);
    }
    // åŒ…è£…ä¸€ä¸‹
    final Object bean = instanceWrapper.getWrappedInstance();
    ...

    // åˆ¤æ–­æ˜¯å¦ä¸ºæ—©æœŸæš´éœ²çš„å•ä¾‹ Bean
    // æ˜¯å•ä¾‹ã€å…è®¸å¾ªç¯ä¾èµ–ã€å½“å‰ beanName ä¹Ÿå°±æ˜¯ â€a" å¤„äºæ­£åœ¨åˆ›å»ºé˜¶æ®µ
    // æ‰€ä»¥ earlySingletonExposure = true
    boolean earlySingletonExposure = (mbd.isSingleton() && this.allowCircularReferences &&
                                      isSingletonCurrentlyInCreation(beanName));
    if (earlySingletonExposure) {
        ...
        // è¿™é‡Œåˆæ˜¯ä¸€ä¸ª lambda è¡¨è¾¾å¼ï¼Œå°†å®ƒåŠ å…¥åˆ°ä¸‰çº§ç¼“å­˜
        addSingletonFactory(beanName, () -> getEarlyBeanReference(beanName, mbd, bean));
        // ç›®å‰ï¼Œä¸‰çº§ç¼“å­˜ä¸­åŒ…å«äº† a
    }

    // åˆå§‹åŒ– bean å®ä¾‹
    Object exposedObject = bean;
    try {
        // èµ‹å€¼å±æ€§
        populateBean(beanName, mbd, instanceWrapper);
        // åˆå§‹åŒ– bean
        exposedObject = initializeBean(beanName, exposedObject, mbd);
    }
    ...

    return exposedObject;
}
```

åœ¨ `doGetBean()` æ–¹æ³•ä¸­

- é€šè¿‡ `createBeanInstance(beanName, mbd, args)` æ–¹æ³•å®ä¾‹åŒ– bean å¯¹è±¡ã€‚
- é€šè¿‡ `addSingletonFactory()` æ–¹æ³•å°†ã€Œè·å– a çš„ æ—©æœŸ bean å¼•ç”¨çš„ lambaè¡¨è¾¾å¼ã€åŠ å…¥åˆ°ä¸‰çº§ç¼“å­˜ï¼Œç”¨äºè§£å†³åé¢å¯èƒ½å‡ºç°çš„å¾ªç¯ä¾èµ–é—®é¢˜ã€‚
- é€šè¿‡ `populateBean()`æ–¹æ³•èµ‹å€¼å±æ€§ã€‚å°±æ˜¯è¦ç»™ a å¯¹è±¡çš„ b å±æ€§è¿›è¡Œèµ‹å€¼ã€‚
- é€šè¿‡ `initializeBean()` æ–¹æ³•åˆå§‹åŒ– bean å¯¹è±¡ã€‚

å¦‚ä½•å®ä¾‹åŒ– bean å¯¹è±¡çš„è¿‡ç¨‹å°±ä¸å…³æ³¨äº†ï¼Œæˆ‘ä»¬ä¸»è¦çœ‹çœ‹å¦‚ä½•ä¸º a å¯¹è±¡è¿›è¡Œå±æ€§èµ‹å€¼ï¼Œçœ‹çœ‹ spring å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜ã€‚ä¸‹é¢çœ‹çœ‹ `populateBean()` æ–¹æ³•ï¼š

```java
protected void populateBean(String beanName, RootBeanDefinition mbd, @Nullable BeanWrapper bw) {
    ...

    PropertyValues pvs = (mbd.hasPropertyValues() ? mbd.getPropertyValues() : null);

    ...
	
    // å¦‚æœ pvs ä¸ä¸º nullï¼Œå°±åº”ç”¨è¿™äº›å€¼
    if (pvs != null) {
        applyPropertyValues(beanName, mbd, bw, pvs);
    }
}
```

ä¸‹é¢çœ‹çœ‹ `applyPropertyValues()` æ–¹æ³•

```java
protected void applyPropertyValues(String beanName, BeanDefinition mbd, BeanWrapper bw, PropertyValues pvs) {
    ...
    for (PropertyValue pv : original) {
        if (pv.isConverted()) {
            deepCopy.add(pv);
        }
        else {
            ...
            // å¦‚æœæœ‰å¿…è¦çš„è¯ï¼Œè§£æä¸€ä¸‹è¿™ä¸ªå€¼ï¼Œè¿™é‡Œä¸€å®šæ˜¯è¦è§£æè¿™ä¸ª b çš„å€¼
            Object resolvedValue = valueResolver.resolveValueIfNecessary(pv, originalValue);
            ...
        }
    }
    ...

    // Set our (possibly massaged) deep copy.
    // å°†å±æ€§èµ‹å€¼
    try {
        bw.setPropertyValues(new MutablePropertyValues(deepCopy));
    }
    ....
}
```

é€šè¿‡ `valueResolver.resolveValueIfNecessary(pv, originalValue)` æ–¹æ³•å»è§£æ

```java
public Object resolveValueIfNecessary(Object argName, @Nullable Object value) {
    // We must check each value to see whether it requires a runtime reference
    // to another bean to be resolved.
    if (value instanceof RuntimeBeanReference) {  // æˆç«‹
        RuntimeBeanReference ref = (RuntimeBeanReference) value;
        return resolveReference(argName, ref);
    }
    ...
}
```

ç”±äº value æ˜¯ RuntimeBeanReference ç±»å‹ï¼Œæ‰€ä»¥ä¼šå»æ‰§è¡Œ `resolveReference(argName, ref)` æ–¹æ³•ã€‚

```java
private Object resolveReference(Object argName, RuntimeBeanReference ref) {
    try {
        Object bean;
        Class<?> beanType = ref.getBeanType();
        if (ref.isToParent()) {
            ...
        }
        else {
            String resolvedName;
            if (beanType != null) {
                ...
            }
            else {
                resolvedName = String.valueOf(doEvaluate(ref.getBeanName()));
                // ç†Ÿæ‚‰çš„æ–¹æ³• getBean
                bean = this.beanFactory.getBean(resolvedName);
            }
            this.beanFactory.registerDependentBean(resolvedName, this.beanName);
        }
        ...
        return bean;
    }
    ...
}
```

å› ä¸ºè¦ç»™ a å¯¹è±¡çš„ b å±æ€§èµ‹å€¼ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦å»å®¹å™¨ä¸­è·å– b å¯¹è±¡ã€‚æ‰€ä»¥æ‰§è¡Œ `this.beanFactory.getBean("b")` æ–¹æ³•ï¼Œä¸‹é¢åˆå›åˆ°äº†ç†Ÿæ‚‰çš„ `getBean()` æµç¨‹ã€‚ç¬¬ä¸€æ¬¡è°ƒç”¨ `getBean()` æ˜¯ä¸ºäº†åˆ›å»º a ï¼Œç›®å‰ a è¿˜æ²¡æœ‰åˆ›å»ºå®Œï¼Œç°åœ¨åˆè°ƒç”¨äº† `getBean()` ï¼Œç›®çš„æ˜¯ä¸ºäº†è·å– bã€‚

<img src="https://raw.githubusercontent.com/zouquchen/Images/main/imgs2022/getBean2times.png" alt="image-20220830113906034" style="zoom:80%;" />

é‚£ä¹ˆå¦‚ä½•è·å– b å‘¢ï¼Ÿæœ‰ä¸€æ®µä¸åˆ›å»º a ç›¸ä¼¼çš„æµç¨‹ã€‚

`getBean()` è°ƒç”¨ `doGetBean() `æ–¹æ³•

```java
protected <T> T doGetBean(final String name, @Nullable final Class<T> requiredType,
			@Nullable final Object[] args, boolean typeCheckOnly) throws BeansException {

    final String beanName = transformedBeanName(name);
    Object bean;

    // Eagerly check singleton cache for manually registered singletons.
    // å…ˆçœ‹çœ‹è¿™ä¸ª bean æœ‰æ²¡æœ‰ï¼Œè¿”å› null
    Object sharedInstance = getSingleton(beanName);
    
    if (sharedInstance != null && args == null) {
        ...
    }

    else {
        ...

        try {
            ...
            // Create bean instance.
            if (mbd.isSingleton()) {
                sharedInstance = getSingleton(beanName, () -> {
                    try {
                        return createBean(beanName, mbd, args);
                    }
                    catch (BeansException ex) {
                        ...
                    }
                });
                bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);
            }
            ...
        }
        catch (BeansException ex) {
            ...
        }
    }
	...
    return (T) bean;
}
```

`getSingleton("b")`è·å–å¯¹è±¡å¤±è´¥ï¼Œåˆæ¥åˆ°äº† `getSingleton(beanName, lambdaè¡¨è¾¾å¼)` æ–¹æ³•ï¼Œè¿›å…¥ `getSingleton()` æ–¹æ³•

```java
public Object getSingleton(String beanName, ObjectFactory<?> singletonFactory) {
    ...
    synchronized (this.singletonObjects) {
        Object singletonObject = this.singletonObjects.get(beanName); // ä»å•ä¾‹æ± ä¸­è·å– bean å¯¹è±¡ï¼Œå¾—ä¸åˆ°ï¼Œè¿”å› null
        if (singletonObject == null) { // if æˆç«‹
            ...
            try {
                singletonObject = singletonFactory.getObject();  // æ‰§è¡Œ getObject()ï¼Œå°±åˆå›åˆ°äº† lambda è¡¨è¾¾å¼
                newSingleton = true;
            }
            ...
            if (newSingleton) {
                addSingleton(beanName, singletonObject);
            }
        }
        return singletonObject;
    }
}
```

æ‰§è¡Œ `getObject()` åˆæ˜¯è°ƒç”¨ lambda è¡¨è¾¾å¼çš„ `createBean()` æ–¹æ³•ï¼Œ`createBean()` æ–¹æ³•åˆè°ƒç”¨ `doCreateBean()` æ–¹æ³•ï¼š

```java
protected Object doCreateBean(final String beanName, final RootBeanDefinition mbd, final @Nullable Object[] args)
			throws BeanCreationException {

    // Instantiate the bean.
    BeanWrapper instanceWrapper = null;
    ...
    // é€šè¿‡åå°„åˆ›å»º bean çš„å®ä¾‹
    if (instanceWrapper == null) {
        instanceWrapper = createBeanInstance(beanName, mbd, args);
    }
    // åŒ…è£…ä¸€ä¸‹
    final Object bean = instanceWrapper.getWrappedInstance();
    ...

    // åˆ¤æ–­æ˜¯å¦ä¸ºæ—©æœŸæš´éœ²çš„å•ä¾‹ Bean
    // æ˜¯å•ä¾‹ã€å…è®¸å¾ªç¯ä¾èµ–ã€å½“å‰ beanName ä¹Ÿå°±æ˜¯ â€a" å¤„äºæ­£åœ¨åˆ›å»ºé˜¶æ®µ
    // æ‰€ä»¥ earlySingletonExposure = true
    boolean earlySingletonExposure = (mbd.isSingleton() && this.allowCircularReferences &&
                                      isSingletonCurrentlyInCreation(beanName));
    if (earlySingletonExposure) {
        ...
        // è¿™é‡Œåˆæ˜¯ä¸€ä¸ª lambda è¡¨è¾¾å¼ï¼Œå°†å®ƒåŠ å…¥åˆ°ä¸‰çº§ç¼“å­˜
        addSingletonFactory(beanName, () -> getEarlyBeanReference(beanName, mbd, bean));
        // ç›®å‰ï¼Œä¸‰çº§ç¼“å­˜ä¸­åŒ…å«äº† a
    }

    // åˆå§‹åŒ– bean å®ä¾‹
    Object exposedObject = bean;
    try {
        // èµ‹å€¼å±æ€§
        populateBean(beanName, mbd, instanceWrapper);
        // åˆå§‹åŒ– bean
        exposedObject = initializeBean(beanName, exposedObject, mbd);
    }
    ...

    return exposedObject;
}
```

æ­¤æ—¶å¼€å§‹åˆ›å»º B å¯¹è±¡ï¼Œç›¸å½“äºåœ¨åˆ›å»º A å¯¹è±¡çš„è¿‡ç¨‹ä¸­åµŒå¥—åˆ›å»ºäº† B å¯¹è±¡ã€‚æ¥ç€çœ‹ B å¯¹è±¡å¤åˆ¶å±æ€§ `populateBean()`ï¼ŒåµŒå¥—è°ƒç”¨ `applyPropertyValues(beanName, mbd, bw, pvs)`èµ‹å€¼å±æ€§ï¼ŒåµŒå¥—è°ƒç”¨ `resolveValueIfNecessary(pv, originalValue)` è§£æå±æ€§ï¼ŒåµŒå¥—è°ƒç”¨ `resolveReference(argName, ref)` è§£æå±æ€§ï¼š

```java
private Object resolveReference(Object argName, RuntimeBeanReference ref) {
    try {
        Object bean;
        Class<?> beanType = ref.getBeanType();
        if (ref.isToParent()) {
            ...
        }
        else {
            String resolvedName;
            if (beanType != null) {
                ...
            }
            else {
                resolvedName = String.valueOf(doEvaluate(ref.getBeanName()));
                // ç†Ÿæ‚‰çš„æ–¹æ³• getBean
                bean = this.beanFactory.getBean(resolvedName);
            }
            this.beanFactory.registerDependentBean(resolvedName, this.beanName);
        }
        ...
        return bean;
    }
    ...
}
```

å†ä¸€æ¬¡çš„æ¥åˆ°äº† `getBean()` æ–¹æ³•ï¼š

<img src="https://raw.githubusercontent.com/zouquchen/Images/main/imgs2022/getBean3times.png" alt="image-20220830124652797" style="zoom:80%;" />

ç¬¬ä¸€æ¬¡ `getBean()`ï¼šä¸ºäº†åˆ›å»º A å¯¹è±¡ã€‚

ç¬¬äºŒæ¬¡ `getBean()`ï¼šä¸ºäº†ç»™ A å¯¹è±¡çš„ B å±æ€§èµ‹å€¼ï¼Œéœ€è¦è·å– B å¯¹è±¡ï¼Œå…¶å®å°±æ˜¯åˆ›å»º B å¯¹è±¡ã€‚

ç¬¬ä¸‰æ¬¡ `getBean()`ï¼šä¸ºäº†ç»™ B å¯¹è±¡çš„ A å±æ€§èµ‹å€¼ï¼Œéœ€è¦è·å– A å¯¹è±¡ã€‚

`getBean()` æ–¹æ³•è°ƒç”¨  `doGetBean()` æ–¹æ³•ï¼š

```java
protected <T> T doGetBean(final String name, @Nullable final Class<T> requiredType,
			@Nullable final Object[] args, boolean typeCheckOnly) throws BeansException {

    final String beanName = transformedBeanName(name);
    Object bean;

    // è¿™ä¸€æ¬¡çœ‹çœ‹ getSingleton("a") èƒ½å¦è·å–åˆ°
    Object sharedInstance = getSingleton(beanName);
    
    if (sharedInstance != null && args == null) {
        ...
    }

    else {
        ...

        try {
            ...
            // Create bean instance.
            if (mbd.isSingleton()) {
                sharedInstance = getSingleton(beanName, () -> {
                    try {
                        return createBean(beanName, mbd, args);
                    }
                    catch (BeansException ex) {
                        ...
                    }
                });
                bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);
            }
            ...
        }
        catch (BeansException ex) {
            ...
        }
    }
	...
    return (T) bean;
}
```

è°ƒç”¨ `getSingleton()` æ–¹æ³•

```java
public Object getSingleton(String beanName) {
    return getSingleton(beanName, true);
}

protected Object getSingleton(String beanName, boolean allowEarlyReference) {
    Object singletonObject = this.singletonObjects.get(beanName);  // å•ä¾‹æ± ä¸­æ²¡æœ‰
    if (singletonObject == null && isSingletonCurrentlyInCreation(beanName)) {  // æ­£åœ¨åˆ›å»ºçš„å¯¹è±¡æˆç«‹
        synchronized (this.singletonObjects) {
            singletonObject = this.earlySingletonObjects.get(beanName); // äºŒçº§ç¼“å­˜ä¸­ä¹Ÿæ²¡æœ‰
            if (singletonObject == null && allowEarlyReference) {  // æˆç«‹
                ObjectFactory<?> singletonFactory = this.singletonFactories.get(beanName); // ä»ä¸‰çº§ç¼“å­˜ä¸­è·å–
                if (singletonFactory != null) { // æˆç«‹
                    singletonObject = singletonFactory.getObject();  // æ‰§è¡Œä¸‰çº§ç¼“å­˜ä¸­å­˜å…¥çš„ lambda è¡¨è¾¾å¼
                    // æ‰§è¡Œå®Œè®°å¾—å›åˆ°è¿™é‡Œ
                    this.earlySingletonObjects.put(beanName, singletonObject);
                    this.singletonFactories.remove(beanName);
                }
            }
        }
    }
    return singletonObject;
}
```

å½“æ—¶å°† `getEarlyBeanReference()` æ”¾å…¥ä¸‰çº§ç¼“å­˜ï¼š

```java
addSingletonFactory(beanName, () -> getEarlyBeanReference(beanName, mbd, bean));
```

æ­¤æ—¶è°ƒç”¨ `getObject()` å°†æ‰§è¡Œ `getEarlyBeanReference()`

```java
protected Object getEarlyBeanReference(String beanName, RootBeanDefinition mbd, Object bean) {
    Object exposedObject = bean; // æš´éœ²å¯¹è±¡
    
    // å¦‚æœå¯¹è±¡æœ‰åç½®å¤„ç†çš„è¯ï¼Œå°±å¯¹ä»–è¿›è¡Œ AOP å¢å¼º
    if (!mbd.isSynthetic() && hasInstantiationAwareBeanPostProcessors()) {
        for (BeanPostProcessor bp : getBeanPostProcessors()) {
            if (bp instanceof SmartInstantiationAwareBeanPostProcessor) {
                SmartInstantiationAwareBeanPostProcessor ibp = (SmartInstantiationAwareBeanPostProcessor) bp;
                exposedObject = ibp.getEarlyBeanReference(exposedObject, beanName);
            }
        }
    }
    // è¿”å›å¤„ç†åçš„å¯¹è±¡
    return exposedObject;
}
```

å¦‚æœæˆ‘ä»¬å¯¹è¿™ä¸ª Bean å¯¹è±¡è¿›è¡Œåç½®å¤„ç†çš„è¯ï¼Œé‚£ä¹ˆä¼šæå‰è¿›è¡Œ AOP å¢å¼ºï¼Œå¹¶è¿”å›å¢å¼ºåçš„ä»£ç†å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰ AOP å¢å¼ºçš„è¯ï¼Œé‚£å°±è¿”å›åŸæ¥çš„å¯¹è±¡ã€‚å›åˆ°åˆšåˆšçš„ `getSingleton()` æ–¹æ³•ï¼š

```java
protected Object getSingleton(String beanName, boolean allowEarlyReference) {
    ..
                    singletonObject = singletonFactory.getObject(); // æ‰§è¡Œå®Œæ¯•ï¼ŒæˆåŠŸè·å– a å¯¹è±¡
                    this.earlySingletonObjects.put(beanName, singletonObject);  // æ”¾å…¥äºŒçº§ç¼“å­˜
                    this.singletonFactories.remove(beanName); // ä»ä¸‰çº§ç¼“å­˜ä¸­ç§»é™¤
                }
            }
        }
    }
    return singletonObject; // è¿”å› a å¯¹è±¡
}
```

åœ¨ `doGetBean()` æ–¹æ³•ä¸­è¿”å› a å¯¹è±¡

```java
protected <T> T doGetBean(final String name, @Nullable final Class<T> requiredType,
                          @Nullable final Object[] args, boolean typeCheckOnly) throws BeansException {

    final String beanName = transformedBeanName(name);
    Object bean;

    // Eagerly check singleton cache for manually registered singletons.
    Object sharedInstance = getSingleton(beanName);   // è·å–a å¯¹è±¡æˆåŠŸ
    if (sharedInstance != null && args == null) {  // æˆç«‹
        ...
        bean = getObjectForBeanInstance(sharedInstance, name, beanName, null);
    }
    ...
    
    return (T) bean;  // è¿”å› a å¯¹è±¡
}
    
```

å†ä¸€æ¬¡å›åˆ° `resolveReference()`ï¼Œä¹‹å‰æˆ‘ä»¬åœ¨è¿™é‡Œè§£æ a å±æ€§ï¼Œå› ä¸ºè¦ç»™ B å¯¹è±¡çš„ a å±æ€§èµ‹å€¼

```java
private Object resolveReference(Object argName, RuntimeBeanReference ref) {
    try {
        ...
            else {
                resolvedName = String.valueOf(doEvaluate(ref.getBeanName()));
                bean = this.beanFactory.getBean(resolvedName); // è·å– a å¯¹è±¡æˆåŠŸ
            }
            this.beanFactory.registerDependentBean(resolvedName, this.beanName);
        }
        ...
        return bean;  // è¿”å› a å¯¹è±¡
    }
    ...
}
```

å†ä¸€æ¬¡å›åˆ° `resolveValueIfNecessary()` æ–¹æ³•

```java
public Object resolveValueIfNecessary(Object argName, @Nullable Object value) {
    if (value instanceof RuntimeBeanReference) {
        RuntimeBeanReference ref = (RuntimeBeanReference) value;
        return resolveReference(argName, ref); // è¿”å› a å¯¹è±¡
    }
    ...
}
```

å†ä¸€æ¬¡å›åˆ° `applyPropertyValues()` æ–¹æ³•ï¼Œä¹‹å‰æˆ‘ä»¬è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ˜¯ä¸ºäº†ç»™ B å¯¹è±¡çš„ a å±æ€§èµ‹å€¼ã€‚

```java
protected void applyPropertyValues(String beanName, BeanDefinition mbd, BeanWrapper bw, PropertyValues pvs) {
    ...
    for (PropertyValue pv : original) {
        if (pv.isConverted()) {
            deepCopy.add(pv);
        }
        else {
            ...
            Object resolvedValue = valueResolver.resolveValueIfNecessary(pv, originalValue); // è¿™é‡Œè¿”å›äº† a å¯¹è±¡
            ...
        }
    }
    ...

    // Set our (possibly massaged) deep copy.
    // å°†å±æ€§èµ‹å€¼
    try {
        bw.setPropertyValues(new MutablePropertyValues(deepCopy)); // è¿™é‡Œå®Œæˆèµ‹å€¼
    }
    ....
}
```

æ­¤æ—¶æ‰§è¡Œå®Œ `bw.setPropertyValues(new MutablePropertyValues(deepCopy))` ä»£ç åï¼ŒB å¯¹è±¡é‡Œé¢å°±åŒ…å«äº† a å±æ€§ã€‚

<img src="https://raw.githubusercontent.com/zouquchen/Images/main/imgs2022/b_contains_a.png" alt="image-20220830131530906" style="zoom:80%;" />

æ­¤æ—¶å†å›åˆ° `doCreateBean()` æ–¹æ³•ç»§ç»­å®Œæˆ B å¯¹è±¡çš„åˆå§‹åŒ–ï¼Œå¹¶è¿”å› B å¯¹è±¡åˆ°  `createBean()` æ–¹æ³•ï¼Œå†è¿”å›åˆ°  `getSingleton()` æ–¹æ³•

```java
public Object getSingleton(String beanName, ObjectFactory<?> singletonFactory) {
    ...
    synchronized (this.singletonObjects) {
        Object singletonObject = this.singletonObjects.get(beanName);
        if (singletonObject == null) {
            ...
            try {
                singletonObject = singletonFactory.getObject(); // åˆšåˆšä»è¿™é‡Œè·å–äº† b å¯¹è±¡
                newSingleton = true;
            }
            ...
            if (newSingleton) {
                addSingleton(beanName, singletonObject);  // æ·»åŠ åˆ°å•ä¾‹æ± ä¸­
            }
        }
        return singletonObject;
    }
}
```

ä¸‹é¢çœ‹çœ‹ `addSingleton(beanName, singletonObject)`æ–¹æ³•ï¼š

```java
protected void addSingleton(String beanName, Object singletonObject) {
    synchronized (this.singletonObjects) {
        this.singletonObjects.put(beanName, singletonObject);  // æ·»åŠ åˆ°ä¸€çº§ç¼“å­˜ï¼ˆå•ä¾‹æ± ï¼‰
        this.singletonFactories.remove(beanName);  // ä»ä¸‰çº§ç¼“å­˜ä¸­ç§»é™¤
        this.earlySingletonObjects.remove(beanName);  // ä»äºŒçº§ç¼“å­˜ä¸­ç§»é™¤
        this.registeredSingletons.add(beanName);
    }
}
```

åˆ°ç›®å‰ä½ç½®ï¼Œb å¯¹è±¡åœ¨ä¸€çº§ç¼“å­˜ï¼Œa å¯¹è±¡åœ¨äºŒçº§ç¼“å­˜ï¼Œb å¯¹è±¡å·²ç»å®Œæˆåˆ›å»ºï¼Œa å¯¹è±¡è¿˜å¤„äºæ­£åœ¨åˆ›å»ºé˜¶æ®µã€‚

![image-20220830132534649](https://raw.githubusercontent.com/zouquchen/Images/main/imgs2022/b_in_1_a_in_2.png)

è¿”å› b å¯¹è±¡åˆ° `doGetBean()` æ–¹æ³•ï¼Œå†è¿”å›åˆ° `getBean()` æ–¹æ³•ï¼Œå†æ¬¡å›åˆ° `resolveReference()`ï¼Œè¿™ä¸€æ¬¡ç»§ç»­å®Œæˆå¯¹ A å¯¹è±¡ b å±æ€§çš„èµ‹å€¼ã€‚

æ­¤æ—¶ï¼Œb å¯¹è±¡å·²ç»å®Œæˆåˆ›å»ºè¿‡ç¨‹ï¼Œå®ƒçš„åˆ›å»ºè¿‡ç¨‹æ˜¯åµŒå¥—åœ¨ a å¯¹è±¡åˆ›å»ºä¸­ã€‚åé¢ï¼Œa å¯¹è±¡ä¹Ÿä¼šç»§ç»­é‡‡ç”¨åŒæ ·çš„æ–¹æ³•å®Œæˆåˆ›å»ºã€‚



### 4.3 æ€»ç»“



## 5. ç–‘é—®

**ç¬¬ä¸‰çº§ç¼“å­˜çš„ä½œç”¨ï¼Ÿ** 

 `Bean` çš„ç”Ÿå‘½å‘¨æœŸå¯çŸ¥ï¼Œ`Bean` åˆå§‹åŒ–æ˜¯ç»è¿‡äº†å®ä¾‹åŒ–ï¼ˆ`createBeanInstance`ï¼‰ã€å±æ€§æ³¨å…¥ï¼ˆ`populateBean`ï¼‰ã€åç½®å¤„ç†å™¨ä¸ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼ˆ`initializeBean`ï¼‰ä¸‰ä¸ªæ­¥éª¤å¤„ç†ï¼Œæœ€ç»ˆæ‰å¾—åˆ°ä¸€ä¸ªåˆ›å»ºå®Œæˆçš„ `Bean`ã€‚

```java
protected Object doCreateBean(...) throws BeanCreationException {
		...
      
    // å®ä¾‹åŒ–bean
    instanceWrapper = createBeanInstance(beanName, mbd, args);
    final Object bean = instanceWrapper.getWrappedInstance();

		// è§£å†³å¾ªç¯ä¾èµ–çš„ä¸€æ­¥ï¼šå°†åˆ›å»ºBeanå¤§æ“ä½œæ”¾å…¥ä¸‰çº§ç¼“å­˜
    boolean earlySingletonExposure = (mbd.isSingleton() && this.allowCircularReferences &&
          isSingletonCurrentlyInCreation(beanName));
    if (earlySingletonExposure) {
       addSingletonFactory(beanName, () -> getEarlyBeanReference(beanName, mbd, bean));
    }

    // åˆå§‹åŒ–Bean
    Object exposedObject = bean;
    try {
       // å±æ€§æ³¨å…¥
       populateBean(beanName, mbd, instanceWrapper);
       // åˆå§‹åŒ–
       exposedObject = initializeBean(beanName, exposedObject, mbd);
    }
		...
}
```

åœ¨å¾ªç¯ä¾èµ–æ—¶ï¼Œåœ¨å±æ€§æ³¨å…¥ï¼ˆ`populateBean`ï¼‰æ­¥éª¤å°±è¦è§£å†³ä¾èµ–é—®é¢˜ï¼Œè€Œ AOP ä»£ç†æ˜¯åœ¨åç½®å¤„ç†å™¨ä¸ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼ˆ`initializeBean`ï¼‰æ­¥éª¤ä¸­é€šè¿‡åç½®å¤„ç†å™¨å®ç°çš„ã€‚å¦‚æœä¸¥æ ¼æŒ‰ç…§ `Bean` çš„è¿™ä¸ªç”Ÿå‘½å‘¨æœŸæ‰§è¡Œï¼Œä¾èµ–æ³¨å…¥æ˜¯æ— æ³•æ³¨å…¥ä»£ç†ä¹‹åçš„å¯¹è±¡çš„ã€‚

`Spring` å¼•å…¥äº†ä¸‰çº§ç¼“å­˜ï¼Œåœ¨å®ä¾‹åŒ–å¯¹è±¡ä¹‹åï¼Œè¿›è¡Œå±æ€§æ³¨å…¥ä¹‹å‰ï¼Œå°†å®ç° AOP ä»£ç†çš„æ­¥éª¤å°è£…ä¸º `Bean` å·¥å‚æ”¾è¿›ä¸‰çº§ç¼“å­˜ã€‚å¦‚æœè¿™ä¸ªå¯¹è±¡è¢«å¾ªç¯ä¾èµ–äº†ï¼Œåˆ™ä½¿ç”¨å·¥å‚æå‰è¿›è¡Œ AOP ä»£ç†ï¼Œå¦‚æœæ²¡æœ‰è¢«å¾ªç¯ä¾èµ–ï¼Œåˆ™è¿™ä¸ªå·¥å‚å°±ä¸ä¼šè¢«ä½¿ç”¨ã€‚

**ä¸ºä»€ä¹ˆç¬¬ä¸‰çº§ç¼“å­˜è¦ç”¨lambdaè¡¨è¾¾å¼ï¼Ÿä¸å¯ä»¥ç›´æ¥è°ƒç”¨æ–¹æ³•å—ï¼Ÿ**

