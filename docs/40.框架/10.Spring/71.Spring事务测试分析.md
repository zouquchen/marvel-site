---
title: Springäº‹åŠ¡æµ‹è¯•åˆ†æ
date: 2022-09-08 23:30:37
permalink: /pages/77e282/
categories:
  - æ¡†æ¶
  - Spring
tags:
  - Spring
  - æ¡†æ¶
author: 
  name: Marvel
  link: https://github.com/zouquchen
---
# Spring äº‹åŠ¡æµ‹è¯•åˆ†æ

## 1. å‰æœŸå‡†å¤‡

â­ **pom ä¾èµ–**ï¼šSpring æ ¸å¿ƒã€mysqlã€jdbcã€æ•°æ®åº“è¿æ¥æ± 

```xml
<dependencies>
    <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-context</artifactId>
        <version>5.2.1.RELEASE</version>
    </dependency>
    <!-- mysql-->
    <dependency>
        <groupId>mysql</groupId>
        <artifactId>mysql-connector-java</artifactId>
        <version>5.1.12</version>
    </dependency>
    <!-- Spring-jdbc ç”¨äºé…ç½®JdbcTemplate -->
    <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-jdbc</artifactId>
        <version>5.0.9.RELEASE</version>
    </dependency>
    <!-- druid æ•°æ®åº“è¿æ¥æ± -->
    <dependency>
        <groupId>com.alibaba</groupId>
        <artifactId>druid</artifactId>
        <version>1.1.8</version>
    </dependency>
</dependencies>
```

â­ **application.xml**ï¼šbean é…ç½®ã€é…ç½® mysqlã€äº‹åŠ¡

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:p="http://www.springframework.org/schema/p"
       xmlns:context="http://www.springframework.org/schema/context" xmlns:tx="http://www.springframework.org/schema/tx"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
                           http://www.springframework.org/schema/beans/spring-beans.xsd
                           http://www.springframework.org/schema/aop
                           https://www.springframework.org/schema/aop/spring-aop.xsd http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd">




    <bean class="com.zqc.service.MyService" id="myService">
        <property name="jdbcTemplate" ref="jdbcTemplate"/>
        <property name="myService" ref="myService"/>
    </bean>

    <!-- é…ç½®mysql -->
    <bean id="dataSource"  class="com.alibaba.druid.pool.DruidDataSource" destroy-method="close">
        <property name="driverClassName" value="com.mysql.jdbc.Driver"/>
        <property name="url" value="xxx"/>
        <property name="username" value="è´¦å·"/>
        <property name="password" value="å¯†ç "/>
    </bean>

    <!-- é…ç½®jdbc-->
    <bean id="jdbcTemplate" class="org.springframework.jdbc.core.JdbcTemplate" p:dataSource-ref="dataSource"/>

    <!-- é…ç½®äº‹åŠ¡-->
    <bean id="dataSourceTransactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
        <property name="dataSource" ref="dataSource"/>
    </bean>
    <tx:annotation-driven transaction-manager="dataSourceTransactionManager"/>
</beans>
```

â­ **MyService** ï¼šä½¿ç”¨ jdbc æ“ä½œæ•°æ®åº“ï¼Œåé¢å°†å¯¹æ”¹ä»£ç è¿›è¡Œä¿®æ”¹å¹¶æµ‹è¯•

```java
public class MyService {

    private JdbcTemplate jdbcTemplate;

    public void login() {
        System.out.println("ç™»å½•ï¼");
    }

    @Transactional(propagation = Propagation.REQUIRED)
    public void test1() {
        jdbcTemplate.execute("insert into course (c_id, c_name, t_id) value ('x1', 'xxx1', '10')");
        test2();
    }

    @Transactional(propagation = Propagation.NEVER)
    public void test2() {
        jdbcTemplate.execute("insert into course (c_id, c_name, t_id) value ('x2', 'xxx2', '20')");
    }

    public JdbcTemplate getJdbcTemplate() {
        return jdbcTemplate;
    }

    public void setJdbcTemplate(JdbcTemplate jdbcTemplate) {
        this.jdbcTemplate = jdbcTemplate;
    }
}
```

## 2. äº‹åŠ¡å¤±æ•ˆè¯´æ˜

### 2.1 äº‹ç‰©å¤±æ•ˆçš„åŸå› 

1. æ–¹æ³•ä¸æ˜¯ public çš„ï¼Œ@Transactional åªèƒ½ç”¨äº public æ–¹æ³•ä¸Šï¼Œå¦åˆ™äº‹åŠ¡ä¸ä¼šç”Ÿæ•ˆï¼Œå¦‚æœè¦ç”¨åœ¨é public æ–¹æ³•ä¸Šï¼Œå¯ä»¥å¼€å¯ AspectJ ä»£ç†æ¨¡å¼
2. æ•°æ®åº“ä¸æ”¯æŒäº‹åŠ¡
3. æ²¡æœ‰è¢« Spring ç®¡ç†
4. å¼‚å¸¸è¢«åƒæ‰ï¼Œäº‹åŠ¡ä¸ä¼šå›æ»šï¼ˆæˆ–è€…æŠ›å‡ºçš„å¼‚å¸¸æ²¡æœ‰è¢«å®šä¹‰ï¼Œé»˜è®¤ä¸º RuntimeExceptionï¼‰
5. æ–¹æ³•äº’ç›¸è°ƒç”¨æ—¶æ³¨è§£å¤±æ•ˆï¼Œéœ€è¦åˆ†ææ˜¯æ™®é€šæ–¹æ³•è¿˜æ˜¯ä»£ç†æ–¹æ³•çš„è°ƒç”¨ï¼Œåªè¦ä»£ç†å¯¹è±¡è°ƒç”¨å…¶ä»–æ–¹æ³•æ—¶æ³¨è§£æ‰ä¼šç”Ÿæ•ˆã€‚

### 2.2 æ–¹æ³•å†…è°ƒç”¨äº‹åŠ¡å¤±æ•ˆè¯´æ˜

ä¸‹é¢è¯¦ç»†è¯´æ˜ç¬¬ 5 ç‚¹ï¼š**æ–¹æ³•äº’ç›¸è°ƒç”¨æ—¶æ³¨è§£å¤±æ•ˆ**

```java
@Transactional(propagation = Propagation.REQUIRED)
public void test1() {
    jdbcTemplate.execute("insert into course (c_id, c_name, t_id) value ('x1', 'xxx1', '10')");
    test2();
}

@Transactional(propagation = Propagation.NEVER)
public void test2() {
    jdbcTemplate.execute("insert into course (c_id, c_name, t_id) value ('x2', 'xxx2', '20')");
}
```

ç¬¬ä¸€éƒ¨åˆ†å·²ç»åˆ—å‡ºçš„ä»£ç ï¼Œ`test1()` å’Œ `test2()` åˆ†åˆ«æ’å…¥æ•°æ®åˆ°æ•°æ®åº“ï¼Œå…¶ä¸­ `test1()` è°ƒç”¨ `test2()`ï¼Œé‚£ä¹ˆæ­¤æ—¶ä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼Ÿ

> äº‹åŠ¡ä¼ æ’­æœºåˆ¶ï¼š
>
> - propagation_requiredï¼šå¦‚æœå¤–éƒ¨æ²¡æœ‰äº‹åŠ¡ï¼Œå°±å¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼›å¦‚æœå¤–éƒ¨å­˜åœ¨ä¸€ä¸ªäº‹åŠ¡ï¼Œå°±åŠ å…¥åˆ°è¯¥äº‹åŠ¡ä¸­ã€‚
> - propagation_neverï¼šå¦‚æœå¤–éƒ¨äº‹åŠ¡ä¸å­˜åœ¨ï¼Œåˆ™ä¸ä½¿ç”¨äº‹åŠ¡ï¼›å¦‚æœå¤–éƒ¨å­˜åœ¨ä¸€ä¸ªäº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚

é”™è¯¯ç†è§£ï¼šå› ä¸º `test2()` çš„äº‹åŠ¡ä¼ æ’­æœºåˆ¶ä¸º neverï¼Œæ‰€ä»¥ `test1()` è°ƒç”¨ `test2()`æ—¶ï¼Œ `test2()` ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚

æ­£ç¡®ç†è§£ï¼šæ­¤æ—¶äº‹åŠ¡å¤±æ•ˆï¼Œä¸¤æ¡æ’å…¥è¯­å¥æ­£å¸¸æ‰§è¡Œã€‚

ğŸš© **é‚£ä¹ˆï¼Œäº‹åŠ¡ä¸ºä»€ä¹ˆä¼šå¤±æ•ˆå‘¢ï¼Ÿ**

åˆ›å»º Spring å®¹å™¨å¹¶å¯åŠ¨ï¼Œä»å®¹å™¨ä¸­è·å– MyService è¿™ä¸ª Bean å¯¹è±¡ã€‚

```java
public class SpringDemo {
    public static void main(String[] args) {
        ApplicationContext context = new ClassPathXmlApplicationContext("applicationContext.xml");
        // AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext(MyConfig.class);
        MyService myService = context.getBean(MyService.class);
        myService.test1();
    }
}
```

é€šè¿‡ Debug è¿›è¡Œè§‚å¯Ÿï¼Œå¯ä»¥çœ‹åˆ°ï¼š

![image-20220913001204791](https://raw.githubusercontent.com/zouquchen/Images/main/imgs2022/myService-Bean.png)

å¯ä»¥çœ‹å‡º myService æ˜¯é€šè¿‡ SpringCGLIB è¿›è¡Œå¢å¼ºçš„ä»£ç†ç±»ï¼Œåé¢ç§°ä¸º MyService$$EnchanceByCGLIBã€‚å…¶ä¸­åŒ…å«å¾ˆå¤šå±æ€§ï¼Œä»‹ç»ä¸€ä¸‹æˆ‘æ˜ç™½çš„ï¼š

- CGLIB$CALLBACK_1
  - targetï¼šè¢«ä»£ç†å¯¹è±¡ï¼Œåé¢ç§°ä¸º MyService$$Original
    - jdbcTemplateï¼šMyService ä¸­æ³¨å…¥çš„ Bean å¯¹è±¡
    - myServiceï¼šå¢å¼ºåçš„ä»£ç†å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ MyService$$EnchanceByCGLIB
- jdbcTemplateï¼šä¸º nullï¼Œè¿™ä¸ªå°±æ˜¯åœ¨ MyService ä¸­æ³¨å…¥çš„ Bean å¯¹è±¡ï¼Œä½†æ˜¯å®ƒä¸ºä»£ç†å¯¹è±¡ï¼Œæ‰€ä»¥ä¸º nullã€‚

ä¸‹é¢å†æ¥ç€è¯´ä¸ºä»€ä¹ˆä¼šå¤±æ•ˆå‘¢ï¼Ÿ

å½“æˆ‘ä»¬è°ƒç”¨ `test1()` çš„æ—¶å€™ï¼Œå®é™…ä¸Šè°ƒç”¨çš„æ˜¯ MyService$$EnchanceByCGLIB çš„ `test1()` æ–¹æ³•ï¼Œå¯ä»¥ä¿è¯ `test1()` çš„äº‹åŠ¡ä¸ä¼šå¤±æ•ˆï¼›ä½†æ˜¯ï¼Œåœ¨ `test1()` æ–¹æ³•å†…è°ƒç”¨ `test2()` æ—¶ï¼Œå®é™…ä¸Šè°ƒç”¨çš„æ˜¯ MyService$$Original çš„ `test2()`ï¼Œä¹Ÿå°±æ˜¯ `MyService$$EnchanceByCGLIB.target.test2()`ï¼Œä¹Ÿå°±æ˜¯æ™®é€šçš„ `test2()`ï¼Œæ‰€ä»¥å®ƒçš„äº‹åŠ¡ä¸ä¼šç”Ÿæ•ˆã€‚

ğŸš© **è§£å†³æ–¹æ¡ˆ**

1. å°†ä¸¤ä¸ªæ–¹æ³•æ”¾åˆ°ä¸¤ä¸ªç±»ä¸­ï¼Œåœ¨å…¶ä¸­ä¸€ä¸ªç±»ä¸­æ³¨å…¥å¦ä¸€ä¸ªç±»åå†è°ƒç”¨ã€‚

2. è‡ªå·±æ³¨å…¥è‡ªå·±

   ```java
   public class MyService {
   	...
   
       private MyService myService;  // è‡ªå·±æ³¨å…¥è‡ªå·±
   
       @Transactional(propagation = Propagation.REQUIRED)
       public void test1() {
           jdbcTemplate.execute("insert into course (c_id, c_name, t_id) value ('x1', 'xxx1', '10')");
           myService.test2();  // è°ƒç”¨æ³¨å…¥çš„ myService çš„ test2() æ–¹æ³•
       }
   
       @Transactional(propagation = Propagation.NESTED)
       public void test2() {
           jdbcTemplate.execute("insert into course (c_id, c_name, t_id) value ('x2', 'xxx2', '20')");
       }
       ...
   }
   ```

## 3. äº‹åŠ¡ä¼ æ’­è¯´æ˜

### 3.1 äº‹åŠ¡ä¼ æ’­æœºåˆ¶

- REQUIREDï¼šå¦‚æœå¤–éƒ¨æ²¡æœ‰äº‹åŠ¡ï¼Œå°±å¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼›å¦‚æœå¤–éƒ¨å­˜åœ¨ä¸€ä¸ªäº‹åŠ¡ï¼Œå°±åŠ å…¥åˆ°è¯¥äº‹åŠ¡ä¸­ã€‚é€‚ç”¨äºå¢åˆ æ”¹ã€‚ï¼ˆå¸¸ç”¨ï¼‰
- SUPPORTSï¼šå¦‚æœå¤–éƒ¨äº‹åŠ¡ä¸å­˜åœ¨ï¼Œåˆ™ä¸ä½¿ç”¨äº‹åŠ¡ï¼›å¦‚æœå¤–éƒ¨å­˜åœ¨ä¸€ä¸ªäº‹åŠ¡ï¼Œå°±åŠ å…¥åˆ°è¯¥äº‹åŠ¡ä¸­ã€‚é€‚ç”¨äºæŸ¥è¯¢æ–¹æ³•ã€‚ï¼ˆå¸¸ç”¨ï¼‰
- MANDATORYï¼šå¦‚æœå¤–éƒ¨äº‹åŠ¡ä¸å­˜åœ¨ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼›å¦‚æœå¤–éƒ¨å­˜åœ¨ä¸€ä¸ªäº‹åŠ¡ï¼Œå°±åŠ å…¥åˆ°è¯¥äº‹åŠ¡ä¸­ã€‚
- REQUIRES_NEWï¼šå¦‚æœå¤–éƒ¨æ²¡æœ‰äº‹åŠ¡ï¼Œå°±å¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼›å¦‚æœå¤–éƒ¨å­˜åœ¨ä¸€ä¸ªäº‹åŠ¡ï¼ŒæŒ‚èµ·å¤–éƒ¨äº‹ç‰©ï¼Œåˆ›å»ºæ–°çš„äº‹ç‰©ã€‚
- NOT_SUPPORTEDï¼šå¦‚æœå¤–éƒ¨æ²¡æœ‰äº‹åŠ¡ï¼Œä¸å¼€å¯äº‹åŠ¡ï¼›å¦‚æœå¤–éƒ¨å­˜åœ¨ä¸€ä¸ªäº‹åŠ¡ï¼ŒæŒ‚èµ·å¤–éƒ¨äº‹ç‰©ã€‚
- NEVERï¼šå¦‚æœå¤–éƒ¨äº‹åŠ¡ä¸å­˜åœ¨ï¼Œåˆ™ä¸ä½¿ç”¨äº‹åŠ¡ï¼›å¦‚æœå¤–éƒ¨å­˜åœ¨ä¸€ä¸ªäº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚
- NESTEDï¼šåµŒå¥—äº‹åŠ¡ï¼Œå¦‚æœå½“å‰äº‹åŠ¡å­˜åœ¨ï¼Œåˆ™åµŒå¥—åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œã€‚å¦‚æœå½“å‰äº‹åŠ¡ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°äº‹ç‰©ã€‚å¦‚æœåµŒå¥—äº‹åŠ¡å‘é€å›æ»šï¼Œåªå›æ»šåµŒå¥—éƒ¨åˆ†çš„äº‹åŠ¡ã€‚

### 3.2 äº‹åŠ¡ä¼ æ’­æœºåˆ¶æµ‹è¯•

åœ¨å¤–éƒ¨äº‹åŠ¡ä½¿ç”¨ propagation_required çš„å‰æä¸‹ï¼Œé€šè¿‡ä¿®æ”¹æŠ›å‡ºå¼‚å¸¸ä½ç½®å’Œå†…éƒ¨äº‹åŠ¡çš„ä¼ æ’­æœºåˆ¶ï¼Œæµ‹è¯•ä»¥ä¸‹ä¹ç§æƒ…å†µã€‚

|              | é‡Œé¢å¼‚å¸¸ï¼Œå¤–é¢ä¸æ•è· | é‡Œé¢å¼‚å¸¸ï¼Œå¤–é¢æ•è·   | å¤–é¢å¼‚å¸¸             |
| ------------ | -------------------- | -------------------- | -------------------- |
| REQUIRED     | éƒ½å›æ»š               | éƒ½å›æ»š               | éƒ½å›æ»š               |
| REQUIRES_NEW | éƒ½å›æ»š               | å¤–é¢ä¸å›æ»šï¼Œé‡Œé¢å›æ»š | å¤–é¢å›æ»šï¼Œé‡Œé¢ä¸å›æ»š |
| NESTED       | éƒ½å›æ»š               | å¤–é¢ä¸å›æ»šï¼Œé‡Œé¢å›æ»š | éƒ½å›æ»š               |

REQUIREDï¼šä¸¤ä¸ªç‹¬ç«‹çš„äº‹ç‰©

NESTEDï¼šé‡Œé¢çš„äº‹ç‰©åµŒå¥—åœ¨å¤–é¢

**æµ‹è¯•æ–¹æ³•**

å¤–é¢å¼‚å¸¸ï¼Œå…¨éƒ¨å›æ»š

```java
@Transactional(propagation = Propagation.REQUIRED)
public void test1() {
    jdbcTemplate.execute("insert into course (c_id, c_name, t_id) value ('x1', 'xxx1', '10')");
    myService.test2();
    throw new RuntimeException("xxx");
}

@Transactional(propagation = Propagation.REQUIRED)
public void test2() {
    jdbcTemplate.execute("insert into course (c_id, c_name, t_id) value ('x2', 'xxx2', '20')");
}
```

é‡Œé¢å¼‚å¸¸ï¼Œå…¨éƒ¨å›æ»š

```java
@Transactional(propagation = Propagation.REQUIRED)
public void test1() {
    jdbcTemplate.execute("insert into course (c_id, c_name, t_id) value ('x1', 'xxx1', '10')");
    myService.test2();
}

@Transactional(propagation = Propagation.REQUIRED)
public void test2() {
    jdbcTemplate.execute("insert into course (c_id, c_name, t_id) value ('x2', 'xxx2', '20')");
    throw new RuntimeException("xxx");
}
```

é‡Œé¢å¼‚å¸¸ï¼Œå¤–é¢æ•è·ï¼Œå…¨éƒ¨å›æ»š

```java
@Transactional(propagation = Propagation.REQUIRED)
public void test1() {
    jdbcTemplate.execute("insert into course (c_id, c_name, t_id) value ('x1', 'xxx1', '10')");
    try {
        myService.test2();
    } catch (Exception e) {
        e.printStackTrace();
    }
    myService.test2();
}

@Transactional(propagation = Propagation.REQUIRED)
public void test2() {
    jdbcTemplate.execute("insert into course (c_id, c_name, t_id) value ('x2', 'xxx2', '20')");
    throw new RuntimeException("xxx");
}
```

ç”¨ç›¸åŒçš„æ–¹å¼æµ‹è¯•å…¶ä»–çš„ä¼ æ’­æœºåˆ¶ã€‚